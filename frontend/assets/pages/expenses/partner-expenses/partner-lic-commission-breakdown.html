<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Partner LIC Commission Breakdown</title>

<link rel="stylesheet" href="/assets/css/main.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    /* --- GENERAL STYLES --- */
    body { background-color: #f4f6f9; font-family: 'Inter', sans-serif; padding: 0; margin: 0; }
    
    .top-green-bar { 
        background-color: #00a65a; color: white; padding: 15px 20px; 
        font-size: 18px; font-weight: 500; display: flex; align-items: center; 
        justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .container { padding: 20px; padding-bottom: 80px; max-width: 98%; margin: 0 auto; }

    /* --- INFO CARDS --- */
    .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
    
    .info-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .info-col { flex: 1; }
    .info-label { font-weight: 600; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    .info-box { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px 15px; font-size: 14px; color: #333; border-radius: 4px; font-weight: 500; }

    /* --- TABLE STYLES --- */
    .details-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 12px; }
    .details-table thead th { 
        background-color: #e9ecef; color: #495057; font-weight: 600; 
        padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; 
        white-space: nowrap; 
    }
    .details-table tbody td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; color: #333; }
    .details-table tbody tr:hover { background-color: #f1f3f5; }

    /* Inputs in table */
    .tbl-input { 
        width: 70px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; 
        text-align: center; font-weight: 600; color: #337ab7;
    }
    .tbl-input:focus { border-color: #337ab7; outline: none; }
    .tbl-input.error { border-color: #d9534f; background-color: #fff5f5; color: #d9534f; }

    /* Conflict Animation */
    .conflict-row { background-color: #ffe6e6 !important; transition: background-color 0.5s; }
    .err-msg { font-size: 10px; color: #d9534f; display: block; margin-top: 2px; }

    /* --- ACTION BUTTONS --- */
    .action-bar { 
        margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px; 
        position: sticky; bottom: 20px; z-index: 90;
    }
    .btn-action { 
        padding: 12px 30px; border-radius: 6px; font-size: 14px; font-weight: 600; 
        cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; 
        transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    }
    .btn-back { background-color: #6c757d; color: white; }
    .btn-save { background-color: #00a65a; color: white; }
    .btn-save:hover { background-color: #008d4c; transform: translateY(-1px); }
    .btn-save:disabled { background-color: #88dcb5; cursor: not-allowed; }

    /* --- TOAST --- */
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px 20px; position: fixed; z-index: 2001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
    @keyframes fadein { from {bottom: 10px; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 10px; opacity: 0;} }
</style>
</head>
<body>

<div class="top-green-bar">
    <span><i class="fas fa-handshake"></i> Partner LIC Commission Breakdown</span>
</div>

<div class="container">
    <div class="card">
        <div class="info-row">
            <div class="info-col">
                <div class="info-label">Partner Name</div>
                <div class="info-box" id="dispName">Loading...</div>
            </div>
            <div class="info-col">
                <div class="info-label">Effective Date</div>
                <div class="info-box" id="dispDate">--</div>
            </div>
        </div>

        <table class="details-table">
            <thead>
                <tr>
                    <th style="width: 40px;">S.NO</th>
                    <th>Dealer</th>
                    <th>Insurance Co</th>
                    <th>Plan Name</th>
                    <th>Term / PPT</th>
                    <th>Fixed Amount</th>
                    <th style="background:#fff3cd; color:#856404; text-align:center;">Dealer % (Max)</th>
                    <th style="background:#d4edda; color:#155724; width: 120px;">Partner %</th>
                    <th>Dealer Entry Date</th>
                    <th style="width: 60px; text-align: center; font-size: 11px;">Apply All<br><input type="checkbox" id="applyAllHeaderCheckbox" title="Toggle all checkboxes below"></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div style="margin-top: 15px; color: #666; font-size: 13px; font-style: italic;">
            <i class="fas fa-info-circle"></i> Note: Rules are fetched from Dealer Settings. You can only edit the Partner Commission Percentage. Partner % cannot exceed Dealer %.
        </div>
    </div>

    <div class="action-bar">
        <button class="btn-action btn-back" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn-action btn-save" onclick="saveData()"><i class="fas fa-save"></i> Save Changes</button>
    </div>
</div>

<div id="toast">Data loaded</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const partnerName = decodeURIComponent(params.get('name') || "Unknown");
    const partnerId = params.get('partnerId');
    const API_BASE = "http://localhost:4000"; 
    
    // --- DATE HANDLER ---
    const rawDate = params.get('date'); 

    /**
     * A robust date parsing and formatting function.
     */
    function formatDate(dateInput, format = 'DD-MM-YYYY') {
        if (!dateInput) return '--';

        let dateObj = null;

        if (dateInput instanceof Date) {
            dateObj = dateInput;
        } else {
            let dateStr = dateInput;
            if (typeof dateStr === 'object' && dateStr.$date) {
                dateStr = dateStr.$date;
            }
            dateStr = String(dateStr).trim();

            if (dateStr.includes('T') || /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                dateObj = new Date(dateStr);
            } 
            else if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('-');
                dateObj = new Date(`${year}-${month}-${day}T00:00:00`); 
            }
            else if (/^\d{8}$/.test(dateStr) && !dateStr.includes('-')) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                dateObj = new Date(`${year}-${month}-${day}T00:00:00`);
            } else {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    dateObj = d;
                }
            }
        }

        if (dateObj && !isNaN(dateObj.getTime())) {
            const year = dateObj.getUTCFullYear();
            const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getUTCDate()).padStart(2, '0');

            if (format === 'YYYY-MM-DD') {
                return `${year}-${month}-${day}`;
            }
            return `${day}-${month}-${year}`; 
        }
        
        return dateInput || '--';
    }

    const selectedDate = formatDate(rawDate || new Date(), 'YYYY-MM-DD');
    document.getElementById('dispDate').innerText = formatDate(selectedDate);
    document.getElementById('dispName').innerText = partnerName;

    // --- API & TABLE LOGIC ---
    async function fetchJson(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) {
                showToast(`Error: ${res.statusText}`, 'error');
                return null;
            }
            const contentType = res.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return await res.json();
            } else {
                showToast('Error: Server did not return valid JSON.', 'error');
                return null;
            }
        }
        catch (err) {
            showToast('Network error. See console.', 'error');
            return null;
        }
    }

    // Load Data
    async function loadSavedData() {
        const url = `${API_BASE}/api/partner-lic-commission/get-breakdown?partnerName=${encodeURIComponent(partnerName)}&date=${selectedDate}`;
        const res = await fetchJson(url);

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let items = res?.success ? res.data : [];

        // Sorting Logic
        items.sort((a, b) => {
            const str = (v) => (v || "").toString().toLowerCase();
            if (str(a.dealerName) !== str(b.dealerName)) return str(a.dealerName).localeCompare(str(b.dealerName));
            if (str(a.insuranceCompany) !== str(b.insuranceCompany)) return str(a.insuranceCompany).localeCompare(str(b.insuranceCompany));
            return str(a.planName).localeCompare(str(b.planName));
        });

        if(items.length > 0) {
            items.forEach((item, index) => addRowToTable(item, index + 1));
            showToast("✅ Rules loaded for " + formatDate(selectedDate));
        } else {
            tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color:#999;">No dealer rules found for this date.</td></tr>`;
            showToast("No dealer rules found for this effective date.", "error");
        }
    }

    function addRowToTable(data, index) {
        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow();
        
        const dealerComm = data.dealerPercent || data.maxPercent || 0; 
        const partnerComm = data.percent || 0;
        const dealerName = data.dealerName || 'Unknown';
        
        const rawDealerDate = data.date || data.commissionDate;
        const dealerEntryDate = formatDate(rawDealerDate);
        const dealerRuleDateValue = formatDate(rawDealerDate, 'YYYY-MM-DD');

        const termPpt = data.termPpt || '-';
        const fixedAmount = data.fixed || 0;
        const insCompany = data.insuranceCompany || 'LIC';

        // --- FIXED: Apply All Checkbox State ---
        const isApplyAll = data.applyToAllPartners === true ? 'checked' : '';

        row.innerHTML = `
            <td>${index}</td>
            <td style="font-weight:600;">${dealerName}</td>
            <td style="font-weight:500;">${insCompany}</td>
            <td>${data.planName}</td>
            <td>${termPpt}</td>
            <td>${fixedAmount}</td>
            <td style="text-align:center; font-weight:bold; color:#856404; background:#fffdf5;">
                <span class="dealer-val">${dealerComm}</span>%
            </td>
            <td style="background:#f1fdf5;">
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <input type="number" class="tbl-input partner-input" 
                           value="${partnerComm}" step="0.01" min="0" 
                           oninput="validateRow(this)">
                    <span class="err-msg"></span>
                </div>
                
                <input type="hidden" class="h-dealername" value="${dealerName}">
                <input type="hidden" class="h-ins-co" value="${insCompany}">
                <input type="hidden" class="h-plan-name" value="${data.planName}">
                <input type="hidden" class="h-term-ppt" value="${termPpt}">
                <input type="hidden" class="h-fixed-amount" value="${fixedAmount}">
                <input type="hidden" class="h-dealer-rule-date" value="${dealerRuleDateValue}">
            </td>
            <td style="text-align:center; color:#555; font-size:11px;">${dealerEntryDate}</td>
            <td style="text-align:center;"><input type="checkbox" class="apply-all-checkbox" ${isApplyAll}></td>
        `;
    }

    // --- VALIDATION: Partner % cannot > Dealer % ---
    function validateRow(input) {
        const row = input.closest('tr');
        const dealerVal = parseFloat(row.querySelector('.dealer-val').innerText) || 0;
        const partnerVal = parseFloat(input.value) || 0;
        const errMsg = row.querySelector('.err-msg');

        if (partnerVal > dealerVal) {
            input.classList.add('error');
            row.classList.add('conflict-row');
            errMsg.innerText = `Max: ${dealerVal}%`;
            return false;
        } else {
            input.classList.remove('error');
            row.classList.remove('conflict-row');
            errMsg.innerText = "";
            return true;
        }
    }

    // --- SAVE ---
    async function saveData() {
        const btn = document.querySelector('.btn-save');
        
        // 1. Check for Validation Errors
        const tableRows = document.getElementById('tableBody').rows;
        if (tableRows.length === 0 || (tableRows.length === 1 && tableRows[0].cells.length === 1)) { 
            showToast("Nothing to save.", "info");
            return;
        }

        const invalidRows = [];
        Array.from(tableRows).forEach((row) => {
            const input = row.querySelector('.partner-input');
            if (input && !validateRow(input)) {
                invalidRows.push(row.cells[0].innerText);
            }
        });

        if (invalidRows.length > 0) {
            alert(`Error in row(s) S.NO: ${invalidRows.join(', ')}. Partner % cannot be greater than Dealer % (Max).`);
            const firstErrorRow = document.querySelector('.conflict-row');
            if(firstErrorRow) firstErrorRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // 2. Prepare Data
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; 
        btn.disabled = true;

        const items = Array.from(tableRows).map(r => {
            return {
                dealerName: r.querySelector('.h-dealername').value,
                insuranceCompany: r.querySelector('.h-ins-co').value,
                planName: r.querySelector('.h-plan-name').value,
                termPpt: r.querySelector('.h-term-ppt').value,
                
                // Robust Number Parsing
                fixed: parseFloat(r.querySelector('.h-fixed-amount').value) || 0,
                dealerPercent: parseFloat(r.querySelector('.dealer-val').innerText) || 0,
                percent: parseFloat(r.querySelector('.partner-input').value) || 0,
                
                dealerRuleDate: r.querySelector('.h-dealer-rule-date').value,
                applyToAllPartners: r.querySelector('.apply-all-checkbox').checked
            };
        });

        const commissionDateForSave = selectedDate;

        try {
            const res = await fetch(`${API_BASE}/api/partner-lic-commission/save-breakdown`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    partnerName, 
                    commissionDate: commissionDateForSave, 
                    items 
                })
            });
            const json = await res.json();
            if(json.success) {
                showToast("✅ Data Saved Successfully!");
                // Optionally reload to verify "Apply All" state immediately
                // loadSavedData(); 
            } else {
                alert("Error: " + json.message);
            }
        } catch(e) { 
            alert("Server Error: " + e.message); 
        } finally { 
            btn.innerHTML = originalText; 
            btn.disabled = false; 
        }
    }

    function showToast(msg, type='success') {
        const t = document.getElementById("toast");
        t.innerText = msg; 
        t.style.backgroundColor = type === 'error' ? '#d9534f' : '#333';
        t.className = "show";
        setTimeout(() => t.className = t.className.replace("show", ""), 3000);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const headerCheckbox = document.getElementById('applyAllHeaderCheckbox');
        if(headerCheckbox) {
            headerCheckbox.addEventListener('click', (event) => {
                const isChecked = event.target.checked;
                document.querySelectorAll('#tableBody .apply-all-checkbox').forEach(cb => {
                    cb.checked = isChecked;
                });
            });
        }
    });

    loadSavedData();
</script>
</body>
</html>