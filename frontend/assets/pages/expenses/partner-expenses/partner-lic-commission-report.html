<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Partner (LIC) Commission Report</title>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f4f6f9; font-family: 'Inter', sans-serif; padding: 15px; margin: 0; }
        .report-header { background: #fff; padding: 10px 15px; border-left: 4px solid #f39c12; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .report-header h2 { font-size: 18px; margin: 0; color: #333; font-weight: 500; }
        
        .status-bar { background: #f39c12; color: white; padding: 8px 15px; font-size: 13px; margin-bottom: 15px; border-radius: 2px; display: flex; justify-content: space-between; align-items: center; }

        .filter-section { background: #fff; padding: 15px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .filter-grid { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 200px; }
        .filter-item label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; }
        
        .input-custom { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 2px; font-size: 13px; box-sizing: border-box; }

        .btn-go { background: #337ab7; color: white; border: none; padding: 7px 15px; border-radius: 3px; cursor: pointer; font-weight: 500; }
        .btn-export { background: #00a65a; color: white; border: none; padding: 7px 15px; border-radius: 3px; cursor: pointer; font-weight: 500; }

        .table-container { background: white; padding: 10px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd; height: 65vh; }
        .report-table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        .report-table th { background: #f8f9fa; color: #333; font-size: 11px; font-weight: 700; padding: 8px; border: 1px solid #ddd; text-align: left; position: sticky; top: 0; z-index: 10; }
        .report-table td { padding: 8px; border: 1px solid #ddd; font-size: 11px; color: #444; white-space: nowrap; }
        
        .footer-summary { background: #fff; padding: 10px; margin-top: 15px; border: 1px solid #ddd; font-weight: 700; color: #333; display: flex; justify-content: flex-end; font-size: 15px; }
        .badge-lic { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: bold; }
        
        #lastUpdated { font-style: italic; font-size: 11px; opacity: 0.8; }
    </style>
</head>
<body>

<div class="report-header">
    <h2><i class="fas fa-umbrella"></i> Partner (LIC) Commission Report</h2>
    <div id="lastUpdated">Last sync: Never</div>
</div>

<div class="status-bar">
    <span><i class="fas fa-calculator"></i> Calculating Life Insurance Payouts</span>
    <span>Next Refresh: <span id="timerText">30</span>s</span>
</div>

<div class="filter-section">
    <div class="filter-grid">
        <div class="filter-item">
            <label>Partner(s) *</label>
            <select id="f_partner" class="js-select2" multiple="multiple" style="width: 100%"></select>
        </div>
        <div class="filter-item">
            <label>LIC Plan Type</label>
            <input type="text" id="f_search" class="input-custom" placeholder="Search Plan / Customer">
        </div>
        <div class="filter-item" style="max-width: 150px;">
            <label>From Date</label>
            <input type="date" id="f_from" class="input-custom">
        </div>
        <div class="filter-item" style="max-width: 150px;">
            <label>To Date</label>
            <input type="date" id="f_to" class="input-custom">
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="btn-go" onclick="handleManualGo()"><i class="fas fa-play"></i> GO</button>
            <button class="btn-export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export</button>
        </div>
    </div>
</div>

<div class="table-container">
    <table class="report-table" id="reportTable">
        <thead>
            <tr>
                <th>S.No.</th>
                <th>Partner Name</th>
                <th>Policy Date</th>
                <th>Policy No</th>
                <th>Customer Name</th>
                <th>Plan Name</th>
                <th>Term/PPT</th>
                <th>Premium Mode</th>
                <th>Inst. Premium</th>
                <th>Payout %</th>
                <th>Fixed</th>
                <th style="background: #fff3e0;">Comm Amount</th>
                <th>Status</th>
                <th>Entry Date</th>
            </tr>
        </thead>
        <tbody id="reportTbody">
            <tr><td colspan="14" style="text-align:center; padding: 30px; color: #888;">Select filters and click GO.</td></tr>
        </tbody>
    </table>
</div>

<div class="footer-summary">
    Total LIC Commission: ₹ <span id="totalComm" style="color: #e65100; margin-left: 10px;">0.00</span>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<script>
    const API_BASE = "http://localhost:4000"; 
    let refreshTimer = 30;

    $(document).ready(function() {
        $('.js-select2').select2({ placeholder: "All", allowClear: true });
        loadFilters();
        setInterval(countdown, 1000);
    });

    async function loadFilters() {
        try {
            const res = await fetch(`${API_BASE}/api/master/partner`).then(r => r.json());
            res.data.forEach(d => $('#f_partner').append(new Option(d.name, d.name)));
        } catch (err) { console.error(err); }
    }

    function countdown() {
        refreshTimer--;
        if(refreshTimer <= 0) { generateReport(true); refreshTimer = 30; }
        document.getElementById('timerText').innerText = refreshTimer;
    }

    function handleManualGo() { refreshTimer = 30; generateReport(false); }

    async function generateReport(isSilent = false) {
        const partners = $('#f_partner').val();
        if (!partners || partners.length === 0) return;

        const tbody = document.getElementById('reportTbody');
        if (!isSilent) tbody.innerHTML = `<tr><td colspan="14" style="text-align:center;">Processing...</td></tr>`;

        try {
            const res = await fetch(`${API_BASE}/api/partner-expenses/report/lic`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    partners,
                    fromDate: $('#f_from').val(),
                    toDate: $('#f_to').val(),
                    search: $('#f_search').val()
                })
            });

            const result = await res.json();
            if (result.success) {
                renderTable(result.data);
                document.getElementById('lastUpdated').innerText = `Last sync: ${new Date().toLocaleTimeString()}`;
            }
        } catch (err) { console.error(err); }
    }

    function renderTable(data) {
        const tbody = document.getElementById('reportTbody');
        tbody.innerHTML = "";
        let grandTotal = 0;

        data.forEach((item, index) => {
            const commAmt = parseFloat(item.commAmt) || 0;
            grandTotal += commAmt;
            tbody.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="font-weight:600;">${item.partnerName}</td>
                    <td>${new Date(item.policyDate).toLocaleDateString('en-GB')}</td>
                    <td>${item.policyNo || '-'}</td>
                    <td>${item.customerName || '-'}</td>
                    <td>${item.planName || '-'}</td>
                    <td>${item.termPpt || '-'}</td>
                    <td>${item.premiumMode || '-'}</td>
                    <td>₹${(item.premium || 0).toLocaleString()}</td>
                    <td style="color: blue; font-weight:bold;">${item.commPercent}%</td>
                    <td>₹${item.fixed || 0}</td>
                    <td style="background: #fff3e0; font-weight: bold; color: #e65100;">₹${commAmt.toFixed(2)}</td>
                    <td><span class="badge-lic">ACTIVE</span></td>
                    <td>${item.entryDate ? new Date(item.entryDate).toLocaleDateString('en-GB') : '-'}</td>
                </tr>`;
        });
        document.getElementById('totalComm').innerText = grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
    }

    function exportToExcel() {
        alert("Exporting LIC Report...");
        // Similar XLSX logic as GIC
    }
</script>
</body>
</html>