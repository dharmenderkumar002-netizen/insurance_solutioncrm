<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Partner (GIC) Commission Report</title>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/gic.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f4f6f9; font-family: 'Inter', sans-serif; padding: 15px; margin: 0; }
        .report-header { background: #fff; padding: 10px 15px; border-left: 4px solid #ff9800; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .report-header h2 { font-size: 18px; margin: 0; color: #333; font-weight: 500; }
        
        .status-bar { background: #00a65a; color: white; padding: 8px 15px; font-size: 13px; margin-bottom: 15px; border-radius: 2px; display: flex; justify-content: space-between; align-items: center; }

        .filter-section { background: #fff; padding: 15px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .filter-grid { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 200px; }
        .filter-item label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; }
        
        .select2-container--default .select2-selection--multiple { border: 1px solid #ccc; border-radius: 2px; min-height: 32px; }
        .input-custom { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 2px; font-size: 13px; box-sizing: border-box; }

        .btn-go { background: #337ab7; color: white; border: none; padding: 7px 15px; border-radius: 3px; cursor: pointer; font-weight: 500; transition: 0.3s; }
        .btn-go:hover { background: #286090; }
        .btn-export { background: #00a65a; color: white; border: none; padding: 7px 15px; border-radius: 3px; cursor: pointer; font-weight: 500; }

        .table-container { background: white; padding: 10px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd; height: 65vh; position: relative; }
        .report-table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        .report-table th { background: #f8f9fa; color: #333; font-size: 11px; font-weight: 700; padding: 8px; border: 1px solid #ddd; text-align: left; position: sticky; top: 0; z-index: 10; }
        .report-table td { padding: 8px; border: 1px solid #ddd; font-size: 11px; color: #444; white-space: nowrap; }
        
        .footer-summary { background: #fff; padding: 10px; margin-top: 15px; border: 1px solid #ddd; font-weight: 700; color: #333; display: flex; justify-content: flex-end; font-size: 15px; }
        .badge { padding: 3px 8px; border-radius: 3px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .badge-active { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        #lastUpdated { font-style: italic; font-size: 11px; opacity: 0.8; }
        #timerText { font-weight: bold; }
    </style>
</head>
<body>

<div class="report-header">
    <h2 id="partnerTitle">Partner (GIC) Commission Report</h2>
    <div id="lastUpdated">Last sync: Never</div>
</div>

<div class="status-bar">
    <span><i class="fas fa-calculator"></i> Processing Commission based on Set Payout Rules</span>
    <span>Next Refresh in: <span id="timerText">30</span>s</span>
</div>

<div class="filter-section">
    <div class="filter-grid">
        <div class="filter-item">
            <label>Partner *</label>
            <select id="f_partner" class="js-select2" style="width: 100%"></select>
        </div>
        <div class="filter-item">
            <label>Insurance Company</label>
            <select id="f_company" class="js-select2" multiple="multiple" style="width: 100%"></select>
        </div>
        <div class="filter-item">
            <label>Quick Search</label>
            <input type="text" id="f_search" class="input-custom" placeholder="Policy / Vehicle / Customer">
        </div>
        <div class="filter-item" style="max-width: 150px;">
            <label>From Date</label>
            <input type="date" id="f_from" class="input-custom">
        </div>
        <div class="filter-item" style="max-width: 150px;">
            <label>To Date</label>
            <input type="date" id="f_to" class="input-custom">
        </div>
         <div class="filter-item" style="align-self: center; margin-top: 15px;">
            <input type="checkbox" id="f_date_type" style="margin-right: 5px;">
            <label for="f_date_type" style="display: inline; font-size: 12px;">Filter by Entry Date</label>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="btn-go" onclick="handleManualGo()"><i class="fas fa-play"></i> GO</button>
            <button class="btn-export" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
        </div>
    </div>
</div>

<div class="table-container">
    <table class="report-table" id="reportTable">
        <thead>
            <tr>
                <th>S.No.</th>
                <th>Partner Name</th>
                <th>Policy Date</th>
                <th>Policy No</th>
                <th>Vehicle No</th>
                <th>Customer Name</th>
                <th>Product</th>
                <th>Vehicle Name</th>
                <th>Fuel</th>
                <th>INS Company</th>                
                <th>Net Premium</th>
                <th>OD Premium</th> 
                <th>Calc On</th> 
                <th>Payout %</th>
                <th>Premium</th>
                <th style="background: #e1f5fe;">Comm Amount</th>
                <th>Status</th>
                <th>Entry Date</th>
            </tr>
        </thead>
        <tbody id="reportTbody">
            <tr><td colspan="18" style="text-align:center; padding: 30px; color: #888;">Select a partner and click GO to process report.</td></tr>
        </tbody>
    </table>
</div>

<div class="footer-summary">
    Grand Total Commission: ₹ <span id="totalComm" style="color: #00a65a; margin-left: 10px;">0.00</span>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

<script>
    const API_BASE = "http://localhost:4000"; 
    let refreshTimer = 30;
    let timerId = null;

    $(document).ready(function() {
        $('#f_partner').select2({ placeholder: "Select a Partner", allowClear: true });
        $('#f_company').select2({ placeholder: "All Companies", allowClear: true });

        loadFilters().then(() => {
            restoreFromUrl();
        });

        startCountdown();
    });

    async function loadFilters() {
        try {
            const [pRes, cRes] = await Promise.all([
                fetch(`${API_BASE}/api/master/partner`).then(r => r.json()),
                fetch(`${API_BASE}/api/master/item/insurancecompany`).then(r => r.json())
            ]);
            
            pRes.data.forEach(p => $('#f_partner').append(new Option(p.name, p.name)));
            cRes.data.forEach(c => $('#f_company').append(new Option(c.name, c.name)));
        } catch (err) { console.error("Filter Load Error:", err); }
    }

    function restoreFromUrl() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('partner')) {
            $('#f_partner').val(params.get('partner')).trigger('change');
            if (params.has('companies')) $('#f_company').val(params.get('companies').split(',')).trigger('change');
            if (params.has('from')) $('#f_from').val(params.get('from'));
            if (params.has('to')) $('#f_to').val(params.get('to'));
            if (params.has('search')) $('#f_search').val(params.get('search'));
            if (params.get('dateType') === 'entryDate') {
                $('#f_date_type').prop('checked', true);
            }
            generateReport(true); 
        }
    }

    function updateUrl() {
        const url = new URL(window.location);
        url.searchParams.set('partner', $('#f_partner').val() || '');
        url.searchParams.set('companies', ($('#f_company').val() || []).join(','));
        url.searchParams.set('from', $('#f_from').val() || '');
        url.searchParams.set('to', $('#f_to').val() || '');
        url.searchParams.set('search', $('#f_search').val() || '');
        url.searchParams.set('dateType', $('#f_date_type').is(':checked') ? 'entryDate' : 'policyDate');
        window.history.pushState({}, '', url);
    }

    function handleManualGo() {
        updateUrl();
        refreshTimer = 30; 
        generateReport(false);
    }

async function generateReport(isSilent = false) {
    const partner = $('#f_partner').val();
    if (!partner) {
        window.reportData = []; // safety
        $('#reportTbody').html('<tr><td colspan="18" style="text-align:center; padding: 30px; color: #888;">Select a partner and click GO to process report.</td></tr>');
        return;
    }

    const tbody = document.getElementById('reportTbody');

    if (!isSilent) {
        tbody.innerHTML = `
            <tr>
                <td colspan="18" style="text-align:center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading Data...
                </td>
            </tr>`;
    }

    try {
        const res = await fetch(`${API_BASE}/api/partner-expenses/report/gic`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                partner,
                companies: $('#f_company').val(),
                fromDate: $('#f_from').val(),
                toDate: $('#f_to').val(),
                search: $('#f_search').val(),
                dateFilterType: document.getElementById('f_date_type').checked ? 'entryDate' : 'policyDate'
            })
        });

        const result = await res.json();

        if (result.success && Array.isArray(result.data)) {
            window.reportData = result.data;
            renderTable(result.data);
            document.getElementById('lastUpdated').innerText = `Last sync: ${new Date().toLocaleTimeString()}`;
        } else {
            window.reportData = [];
            tbody.innerHTML = `
                <tr>
                    <td colspan="18" style="text-align:center; padding:20px; color:#999;">
                        No data found for the selected criteria.
                    </td>
                </tr>`;
        }

    } catch (err) {
        console.error("Commission Report Error:", err);
        window.reportData = [];
        tbody.innerHTML = `
            <tr>
                <td colspan="18" style="text-align:center; padding:20px; color:red;">
                    An error occurred while fetching the report. Check console for details.
                </td>
            </tr>`;
    }
}
    function renderTable(data) {
        const tbody = document.getElementById('reportTbody');
        tbody.innerHTML = "";
        let grandTotal = 0;

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="18" style="text-align:center; padding:20px; color:#999;">No data found for the selected criteria.</td></tr>`;
            document.getElementById('totalComm').innerText = '0.00';
            return;
        }

        data.forEach((item, index) => {
            // Safe Number Parsing
            const netPrem = parseFloat(String(item.netPremium).replace(/,/g, '')) || 0;
            const odPrem = parseFloat(String(item.odPremium).replace(/,/g, '')) || 0;
            const percent = parseFloat(item.commPercent) || 0;
            const fixed = parseFloat(item.fixed) || 0;
            
            const commAmt = Number(item.commAmt) || 0;
            const displayCriteria = item.calcOn || "OD PREMIUM";
            const isNet = displayCriteria.toUpperCase().includes("NET");

            grandTotal += commAmt;
            tbody.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="font-weight: 600;">${item.partnerName}</td>
                    <td>${new Date(item.policyDate).toLocaleDateString('en-GB')}</td>
                    <td>${item.policyNo || '-'}</td>
                    <td>${item.vehicleNo || '-'}</td>
                    <td>${item.customerName || 'Unknown'}</td>
                    <td>${item.gicProduct || '-'}</td>
                    <td>${item.vehicleName || '-'}</td>
                    <td>${item.fuelType || '-'}</td>
                    <td>${item.insCompany || '-'}</td>
                    
                    <td style="${isNet ? 'background:#e8f5e9; color:#2e7d32; font-weight:bold; border:2px solid #2e7d32;' : ''}">
                        ₹${netPrem.toLocaleString('en-IN')}
                    </td>
                    
                    <td style="${!isNet ? 'background:#fff3e0; color:#ef6c00; font-weight:bold; border:2px solid #ef6c00;' : ''}">
                        ₹${odPrem.toLocaleString('en-IN')}
                    </td> 
                    
                    <td style="font-size:10px; font-weight:bold; color: ${isNet ? '#2e7d32' : '#ef6c00'};">
                        ${displayCriteria}
                    </td>
                    
                    <td style="color: blue; font-weight:bold;">${percent}%</td>
                    <td>₹${(item.premium || 0).toLocaleString('en-IN')}</td>
                    
                    <td style="background: #e1f5fe; font-weight: bold; color: #007bff; font-size: 13px;">
                        ₹${commAmt.toFixed(2)}
                    </td>
                    
                    <td><span class="badge badge-active">${item.status || 'DONE'}</span></td>
                    <td>${item.entryDate ? new Date(item.entryDate).toLocaleDateString('en-GB') : '-'}</td>
                </tr>`;
        });
        document.getElementById('totalComm').innerText = grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
    }

    function startCountdown() {
        if(timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            refreshTimer--;
            if(refreshTimer <= 0) {
                generateReport(true);
                refreshTimer = 30;
            }
            document.getElementById('timerText').innerText = refreshTimer;
        }, 1000);
    }

function formatDateDDMMYYYY(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
}


function exportToExcel() {
    if (!window.reportData || window.reportData.length === 0) {
        alert("No data to export");
        return;
    }

    const rows = [];
    const colCount = 21; 

    rows.push(["INSURANCE SOLUTION"]); 
    rows.push(["PARTNER GIC COMMISSION REPORT"]);
    
    const partnerName = $("#f_partner").val() || "All";
    const companyNames = ($("#f_company").val() || []).join(", ") || "All";
    rows.push([ `Partner: ${partnerName}  |  Company: ${companyNames}` ]);
    
    const dateFilterType = $('#f_date_type').is(':checked') ? 'Entry Date' : 'Policy Issue Date';
    rows.push([ `Date Range: ${formatDateDDMMYYYY($("#f_from").val())} TO ${formatDateDDMMYYYY($("#f_to").val())} (by ${dateFilterType}) |  Generated On: ${new Date().toLocaleDateString('en-GB')}` ]);
    
    const headerRowIndex = rows.length;
    const headers = [
        "S.No", "Vehicle No", "Policy No", "Customer Name", "Partner",
        "Ins. Company", "Vehicle Name", "Product", "CC/GVW", "Coverage",
        "Fuel", "PA", "NCB %",
        "Premium", "Net Premium", "OD Premium",
        "OD End", "Mode", "Payout %", "Comm Amount", "Calc On"
    ];
    rows.push(headers);

    let currentExcelRow = headerRowIndex + 2; 

    window.reportData.forEach((item, index) => {
        const criteria = (item.calcOn || 'OD').toUpperCase();
        let commFormulaCell = 0;
        
        const percent = parseFloat(item.commPercent) || 0;
        const fixed = parseFloat(item.fixed) || 0;

        if (percent > 0) {
            if (criteria.includes('NET')) {
                commFormulaCell = { f: `ROUND(O${currentExcelRow}*S${currentExcelRow}/100, 2) + ${fixed}` };
            } else {
                commFormulaCell = { f: `ROUND(P${currentExcelRow}*S${currentExcelRow}/100, 2) + ${fixed}` };
            }
        } else if (fixed > 0) {
             commFormulaCell = fixed;
        }

        rows.push([
            index + 1,
            item.vehicleNo || "", item.policyNo || "", item.customerName || "",
            item.partnerName || "", item.insCompany || "", item.vehicleName || "",
            item.gicProduct || "", item.ccKwGvw || "", item.coverageType || "",
            item.fuelType || "", item.pa || 0, item.ncb || 0,
            item.premium || 0, item.netPremium || 0, item.odPremium || 0,
            formatDateDDMMYYYY(item.odEndDate), item.paymentMode || "",
            item.commPercent || 0, commFormulaCell, item.calcOn || ""
        ]);
        currentExcelRow++;
    });

    const lastDataRowIndex = rows.length - 1;
    const dataStartExcelRow = headerRowIndex + 2;

    for(let i=0; i<5; i++) {
        rows.push(Array(colCount).fill(""));
    }

    const totalRowIndex = rows.length;
    const sumRangeEndExcelRow = totalRowIndex; 

    rows.push([
        "TOTAL", "", "", "", "", "", "", "", "", "", "", "", "",
        { f: `SUM(N${dataStartExcelRow}:N${sumRangeEndExcelRow})` },
        { f: `SUM(O${dataStartExcelRow}:O${sumRangeEndExcelRow})` },
        { f: `SUM(P${dataStartExcelRow}:P${sumRangeEndExcelRow})` },
        "", "", "",
        { f: `SUM(T${dataStartExcelRow}:T${sumRangeEndExcelRow})` },
        ""
    ]);

    const ws = XLSX.utils.aoa_to_sheet(rows);

    ws["!merges"] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } },
        { s: { r: 1, c: 0 }, e: { r: 1, c: colCount - 1 } },
        { s: { r: 2, c: 0 }, e: { r: 2, c: colCount - 1 } },
        { s: { r: 3, c: 0 }, e: { r: 3, c: colCount - 1 } }
    ];

    const range = XLSX.utils.decode_range(ws["!ref"]);
    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cellAddr]) ws[cellAddr] = { t: 's', v: '' };
            const cell = ws[cellAddr];

            cell.s = {
                font: { name: "Calibri", sz: 10 },
                alignment: { vertical: "center", horizontal: "left" },
                border: { top: { style: "thin", color: { rgb: "B2B2B2" } }, bottom: { style: "thin", color: { rgb: "B2B2B2" } }, left: { style: "thin", color: { rgb: "B2B2B2" } }, right: { style: "thin", color: { rgb: "B2B2B2" } } }
            };

            if (R <= 1) {
                cell.s.fill = { fgColor: { rgb: "1F4E79" } }; 
                cell.s.font = { bold: true, sz: 14, color: { rgb: "FFFFFF" } };
                cell.s.alignment = { horizontal: "left", vertical: "center" };
            } else if (R <= 3) {
                cell.s.fill = { fgColor: { rgb: "DCE6F1" } };
                cell.s.font = { bold: true, sz: 10 };
                cell.s.alignment = { horizontal: "left", vertical: "center" };
            } else if (R === headerRowIndex) {
                cell.s.fill = { fgColor: { rgb: "00A65A" } };
                cell.s.font = { bold: true, color: { rgb: "FFFFFF" }, sz: 11 };
                cell.s.alignment = { horizontal: "center", vertical: "center" };
            } else if (R > headerRowIndex && R < totalRowIndex) {
                 if ([13,14,15,18,19].includes(C)) {
                    cell.s.alignment = { horizontal: "right" };
                    cell.z = '#,##0.00';
                 }
                 if (R > lastDataRowIndex) {
                     cell.s.border = {};
                 }
            } else if (R === totalRowIndex) {
                cell.s.fill = { fgColor: { rgb: "E1F5FE" } };
                cell.s.font = { bold: true, sz: 11 };
                cell.s.border = { top: { style: "medium", color: { rgb: "00A65A" } }, bottom: { style: "medium", color: { rgb: "00A65A" } } };
                 if ([13,14,15,19].includes(C)) {
                    cell.s.alignment = { horizontal: "right" };
                    cell.z = '₹ #,##0.00';
                 }
            }
        }
    }

    ws["!cols"] = [
        { wch: 6 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 15 },
        { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
        { wch: 10 }, { wch: 8 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 16 }, { wch: 14 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "GIC Commission");
    XLSX.writeFile(wb, `Partner_GIC_Commission_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>

</body>
</html>