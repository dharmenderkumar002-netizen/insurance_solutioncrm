<!DOCTYPE html>
<html lang="en">
<head>
<script>
    // Redirect to main layout if not in an iframe.
    // This prevents direct access to the page.
    if (window.self === window.top) {
        // The path to layout.html from this page.
        window.location.href = '../../layout.html';
    }
</script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Non-Motor Commission Breakdown</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/gic.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ORIGINAL UI STYLES */
        body { background-color: #fff; font-family: 'Inter', sans-serif; padding: 0; margin: 0; }
        
        /* Purple Theme */
        .top-bar { background-color: #605ca8; color: white; padding: 10px 20px; font-size: 16px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; }
        
        .container { padding: 20px; padding-bottom: 80px; }
        .info-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .info-col { flex: 1; }
        .info-label { font-weight: bold; font-size: 13px; color: #333; margin-bottom: 5px; }
        .info-box { background-color: #f0f0f0; border: 1px solid #ccc; padding: 8px 12px; font-size: 13px; color: #555; border-radius: 3px; }
        
        .details-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .details-table thead th { background-color: #d1c4e9; color: #333; font-weight: 600; padding: 8px; text-align: left; font-size: 11px; border: 1px solid #ddd; white-space: nowrap; }
        .details-table tbody td { padding: 6px; border: 1px solid #ddd; vertical-align: middle; font-size: 11px; }
        
        /* Conflict Highlight Style */
        .conflict-row { background-color: #ffe6e6 !important; transition: background-color 0.5s; }
        
        .action-cell { display: flex; justify-content: center; gap: 12px; }
        .edit-btn { color: #337ab7; cursor: pointer; font-size: 14px; }
        .remove-btn { color: #d9534f; cursor: pointer; font-size: 14px; }
        
        .action-bar { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-action { padding: 10px 25px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; }
        .btn-back { background-color: #6c757d; color: white; }
        .btn-save { background-color: #605ca8; color: white; }
        
        /* Modal Style */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 600px; max-width: 95%; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { background: #605ca8; color: white; padding: 12px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 80vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full-width { grid-column: span 2; }
        .form-group label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
        
        .modal-footer { padding: 15px 20px; background: #f9f9f9; text-align: right; border-top: 1px solid #eee; }
        .btn-close { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;}
        .btn-add { background: #337ab7; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 2001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    </style>
</head>
<body>

<div class="top-bar">
    <span>Add Non-Motor Commission</span>
</div>

<div class="container">
    <div class="info-row">
        <div class="info-col">
            <div class="info-label">Dealer Name</div>
            <div class="info-box" id="dispName">Loading...</div>
        </div>
        <div class="info-col">
                <div class="info-label">Effective Date</div>
                <div class="info-box" id="dispDate">--</div>
        </div>
        
    </div>

    <table class="details-table">
        <thead>
            <tr>
                <th>Sno.</th>
                <th>Company</th>
                <th>Product</th>
                <th>Policy Type</th>
                <th>Net Premium Range</th>
                <th>Fixed Amount</th>
                <th>Percentage (%)</th>
                <th style="text-align:center;">Action</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button class="btn-action" style="background:#337ab7; color:white; margin-top:15px;" onclick="openModal()">
        <i class="fas fa-plus"></i> Add New Criteria
    </button>

    <div class="action-bar">
        <button class="btn-action btn-back" onclick="window.history.back()">Back</button>
        <button class="btn-action btn-save" id="btnSave" onclick="saveData()">Save Commission</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-content" style="width: 350px; padding: 20px; text-align: center;">
        <h4>Confirm Delete</h4>
        <p>Are you sure you want to delete this?</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
            <button onclick="closeConfirmModal()" style="padding:8px 20px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">No</button>
            <button id="btnConfirmDelete" style="padding:8px 20px; background:#d9534f; color:white; border:none; border-radius:4px; cursor:pointer;">Yes, Delete</button>
        </div>
    </div>
</div>

<div id="toast">Data loaded</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">Add Commission Criteria</span>
            <span class="close-icon" onclick="closeModal()" style="cursor:pointer;">‚úñ</span>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label>Insurance Company *</label>
                    <select id="m_company"><option value="">Select Company</option></select>
                </div>
                <div class="form-group">
                    <label>Non-Motor Product *</label>
                    <select id="m_product"><option value="">Select Product</option></select>
                </div>
                <div class="form-group">
                    <label>Policy Type</label>
                    <select id="m_policy_type">
                        <option value="All">All Types</option>
                        <option value="Fresh">Fresh</option>
                        <option value="Renewal">Renewal</option>
                        <option value="Rollover">Rollover</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label>Net Premium Range (‚Çπ)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="m_prem_from" placeholder="Min (0)">
                        <input type="text" id="m_prem_to" placeholder="Max (Default: Max)">
                    </div>
                </div>
                
                <div class="form-group"><label>Fixed Amount (‚Çπ)</label><input type="number" id="m_fixed" value="0"></div>
                <div class="form-group"><label>Percentage (%)</label><input type="number" id="m_percent" value="0"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-close" onclick="closeModal()">Cancel</button>
            <button class="btn-add" id="modalBtnAction" onclick="addCriteriaToTable()">Add to List</button>
        </div>
    </div>
</div>

<script>
    // Use a relative path for the API base. This works for both local and production.
    // Assumes frontend and backend are on the same domain.
    const API_BASE = "";
    const params = new URLSearchParams(window.location.search);
    const dealerName = decodeURIComponent(params.get('name') || "Unknown");
    
    // --- DATE HANDLER (Fixed) ---
    // Helper to get Today in YYYY-MM-DD
    const getToday = () => {
        const d = new Date();
        return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    };

    // 1. Get Date from URL or use Today
    let rawDate = params.get('date');
    if (!rawDate || rawDate === "undefined" || rawDate === "null") {
        rawDate = getToday();
    }

    let yyyy, mm, dd, selectedDateISO;

    // 2. FIX: Handle both formats (YYYYMMDD and YYYY-MM-DD)
    if (rawDate.length === 8 && !rawDate.includes('-')) {
        // Incoming format: 20260105 (Fixes undefined-undefined error)
        yyyy = rawDate.substring(0, 4);
        mm = rawDate.substring(4, 6);
        dd = rawDate.substring(6, 8);
        selectedDateISO = `${yyyy}-${mm}-${dd}`; // Standardize for API
    } else {
        // Incoming format: 2026-01-05
        selectedDateISO = rawDate;
        [yyyy, mm, dd] = selectedDateISO.split('-');
    }

    // 3. Update UI
    document.getElementById('dispName').innerText = dealerName;
    document.getElementById('dispDate').innerText = `${dd}-${mm}-${yyyy}`;
    let editingRow = null;
    let rowToDelete = null;

    // --- API HELPER ---
    async function fetchJson(url) {
        try { const res = await fetch(url); return await res.json(); }
        catch (err) { console.error(err); return null; }
    }

    // --- LOAD MASTERS ---
    async function loadMasters() {
    const [cData, pData] = await Promise.all([
        fetchJson(`${API_BASE}/api/master/item/insurancecompany`),
        // üëá Change this URL to your Non-Motor API endpoint
        fetchJson(`${API_BASE}/api/master/item/nonmotorproduct`) 
    ]);
    
    populateSelect('m_company', cData, 'companyName');
    populateSelect('m_product', pData, 'name'); 
}

    function populateSelect(id, json, key) {
        const select = document.getElementById(id);
        if(!json || !json.data) return;
        const dataArray = Array.isArray(json.data) ? json.data : [];
        select.innerHTML = '<option value="">Select</option>';
        dataArray.forEach(item => {
            if (item.status && item.status !== "Active") return; 
            const val = item[key] || item.name;
            if(val) {
                const opt = document.createElement('option');
                opt.value = val; opt.textContent = val;
                select.appendChild(opt);
            }
        });
    }

    // --- UI ACTIONS ---
    function openModal(isEdit = false) {
        document.getElementById('addModal').style.display = 'flex';
        if(!isEdit) {
            editingRow = null;
            document.getElementById('modalTitle').innerText = "Add Commission Criteria";
            document.getElementById('modalBtnAction').innerText = "Add to List";
            clearForm();
        }
    }
    function closeModal() { document.getElementById('addModal').style.display = 'none'; editingRow = null; }

    function clearForm() {
        document.getElementById('m_prem_from').value = "0";
        document.getElementById('m_prem_to').value = "Max";
        document.getElementById('m_fixed').value = "0";
        document.getElementById('m_percent').value = "0";
        document.getElementById('m_policy_type').value = "All";
        document.getElementById('m_company').selectedIndex = 0;
        document.getElementById('m_product').selectedIndex = 0;
    }

    function addCriteriaToTable() {
        const data = {
            company: document.getElementById('m_company').value,
            product: document.getElementById('m_product').value,
            policyType: document.getElementById('m_policy_type').value,
            premFrom: document.getElementById('m_prem_from').value || '0',
            premTo: document.getElementById('m_prem_to').value || 'Max',
            fixed: document.getElementById('m_fixed').value || 0,
            percent: document.getElementById('m_percent').value || 0
        };
        
        if(!data.company || !data.product) { alert("Company and Product are required"); return; }
        
        // Simple overlap check logic here if needed...

        if (editingRow) { updateRow(editingRow, data); } else { addRowToTable(data); }
        closeModal();
    }

    function addRowToTable(data) {
        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow();
        updateRow(row, data);
    }

    function updateRow(row, data) {
        row.innerHTML = `
            <td style="text-align:center;">${row.rowIndex}</td>
            <td>${data.company}</td>
            <td>${data.product}</td>
            <td>${data.policyType}</td>
            <td>${data.premFrom}-${data.premTo}</td>
            <td>‚Çπ${data.fixed}</td>
            <td>${data.percent}%</td>
            <td class="action-cell">
                <i class="fas fa-edit edit-btn" onclick="editRow(this)" title="Edit"></i>
                <i class="fas fa-trash remove-btn" onclick="removeRow(this)" title="Delete"></i>
            </td>
        `;
        reindexRows();
    }

    function editRow(btn) {
        editingRow = btn.closest('tr');
        const cells = editingRow.cells;
        document.getElementById('m_company').value = cells[1].innerText;
        document.getElementById('m_product').value = cells[2].innerText;
        document.getElementById('m_policy_type').value = cells[3].innerText;
        const rangeParts = cells[4].innerText.split('-');
        document.getElementById('m_prem_from').value = rangeParts[0];
        document.getElementById('m_prem_to').value = rangeParts[1];
        document.getElementById('m_fixed').value = cells[5].innerText.replace('‚Çπ','');
        document.getElementById('m_percent').value = cells[6].innerText.replace('%','');
        
        openModal(true);
        document.getElementById('modalTitle').innerText = "Edit Criteria";
        document.getElementById('modalBtnAction').innerText = "Update";
    }

    function removeRow(btn) {
        rowToDelete = btn.closest('tr');
        document.getElementById('confirmModal').style.display = 'flex';
    }

    document.getElementById('btnConfirmDelete').onclick = function() {
        if (rowToDelete) {
            rowToDelete.remove();
            reindexRows();
            closeConfirmModal();
        }
    };

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        rowToDelete = null;
    }
    
    function reindexRows() {
        Array.from(document.getElementById('tableBody').rows).forEach((r, i) => r.cells[0].innerText = i + 1);
    }

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // ============================================
    // üöÄ LOAD LOGIC (AUTO PICK LATEST)
    // ============================================
    async function loadSavedData() {
        const safeName = encodeURIComponent(dealerName);
        
        // 1. Try Specific Date
        let url = `${API_BASE}/api/expenses/nonmotor/get-breakdown?dealerName=${safeName}&date=${selectedDateISO}`;
        let res = await fetchJson(url);
        
        // 2. If no data, Fetch Latest (Previous Record)
        if (!res || !res.data || res.data.length === 0) {
            url = `${API_BASE}/api/expenses/nonmotor/get-breakdown?dealerName=${safeName}&fetchLatest=true`;
            res = await fetchJson(url);
            
            if (res && res.data && res.data.length > 0) {
                showToast("Loaded previous records (Auto-fill)");
            }
        }

        // Render Table
        if(res && res.success && res.data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            res.data.forEach(item => {
                const max = (item.maxPremium > 90000000) ? 'Max' : item.maxPremium;
                addRowToTable({
                    company: item.company, 
                    product: item.product, 
                    policyType: item.policyType,
                    premFrom: item.minPremium, 
                    premTo: max,
                    fixed: item.fixedAmount, 
                    percent: item.percentage
                });
            });
        }
    }

    // ============================================
    // üíæ SAVE LOGIC (CREATES NEW ENTRY)
    // ============================================
    async function saveData() {
        const rows = document.getElementById('tableBody').rows;
        if(rows.length === 0) return alert("Please add at least one criteria");
        
        const items = [];
        Array.from(rows).forEach(r => {
            const rangeParts = r.cells[4].innerText.split('-');
            const maxVal = rangeParts[1] === 'Max' ? 999999999 : Number(rangeParts[1]);

            items.push({
                company: r.cells[1].innerText,
                product: r.cells[2].innerText,
                policyType: r.cells[3].innerText,
                minPremium: Number(rangeParts[0]), 
                maxPremium: maxVal, 
                fixedAmount: Number(r.cells[5].innerText.replace('‚Çπ', '')), 
                percentage: Number(r.cells[6].innerText.replace('%', '')) 
            });
        });

        const payload = {
            dealerName,
            date: selectedDateISO, // ALWAYS saves for the CURRENT selected date
            items
        };

        const btn = document.getElementById('btnSave');
        btn.innerHTML = "Saving..."; btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/api/expenses/nonmotor/save-breakdown`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            
            if (json.success) showToast("‚úÖ Data Saved Successfully!");
            else alert("‚ùå Error: " + json.message);
        } catch (err) { 
            console.error(err);
            alert("‚ùå Server Error!"); 
        } finally {
            btn.innerHTML = "Save Commission"; btn.disabled = false;
        }
    }

    // Initialize
    loadMasters();
    loadSavedData();
</script>
</body>
</html>