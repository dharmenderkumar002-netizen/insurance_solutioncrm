<!DOCTYPE html>
<html lang="en">
<head>
<script>
    // Redirect to main layout if not in an iframe.
    // This prevents direct access to the page.
    if (window.self === window.top) {
        // The path to layout.html from this page.
        window.location.href = '../../layout.html';
    }
</script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LIC Commission Breakdown</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/gic.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Inter', sans-serif; padding: 0; margin: 0; }
        .top-bar { background-color: #f39c12; color: white; padding: 15px 20px; font-size: 18px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { 
        padding: 10px; /* Thoda padding kam kiya taaki aur space mile */
        padding-bottom: 80px; 
        max-width: 98%; /* 1200px se 98% kar diya taaki full width ho jaye */
        margin: 0 auto; 
    }
        
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }

        .info-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .info-col { flex: 1; }
        .info-label { font-weight: 600; font-size: 12px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .info-box { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px 15px; font-size: 14px; color: #333; border-radius: 4px; font-weight: 500; }
        
        .details-table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #eee; }
        .details-table thead th { background-color: #fff3e0; color: #e67e22; font-weight: 600; padding: 12px 10px; text-align: left; font-size: 12px; border-bottom: 2px solid #ffe0b2; }
        .details-table tbody td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 13px; color: #333; }
        .details-table tbody tr:hover { background-color: #fcfcfc; }
        
        /* Action Buttons */
        .action-cell { display: flex; justify-content: center; gap: 15px; }
        .edit-btn { color: #337ab7; cursor: pointer; font-size: 14px; transition: color 0.2s; }
        .remove-btn { color: #d9534f; cursor: pointer; font-size: 14px; transition: color 0.2s; }
        .edit-btn:hover { color: #23527c; }
        .remove-btn:hover { color: #a94442; }

        .action-bar { margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-action { padding: 12px 25px; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
        .btn-back { background-color: #6c757d; color: white; }
        .btn-save { background-color: #f39c12; color: white; }
        .btn-save:hover { background-color: #e67e22; transform: translateY(-1px); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 550px; max-width: 95%; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { background: #f39c12; color: white; padding: 15px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; color: #555; text-transform: uppercase; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #f39c12; }

        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px 20px; position: fixed; z-index: 2001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 10px; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 10px; opacity: 0;} }
    </style>
</head>
<body>

<div class="top-bar">
    <span><i class="fas fa-umbrella"></i> LIC Commission Setup</span>
</div>

<div class="container">
    <div class="card">
        <h3 style="color: #e67e22; margin-top:0;">LIC Commission Breakdown</h3>
        <div class="info-row">
            <div class="info-col">
                <div class="info-label">Dealer Name</div>
                <div class="info-box" id="dispName">Loading...</div>
            </div>
            <div class="info-col">
                <div class="info-label">Effective Date</div>
                <div class="info-box" id="dispDate">--</div>
            </div>
        </div>

        <table class="details-table">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="20%">Insurance Co</th> 
                    <th>Plan Name</th>
                    <th>Term / PPT</th>
                    <th>Fixed Amount</th>
                    <th>Percentage (%)</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <button class="btn-action" style="background:#337ab7; color:white; margin-top:20px; font-size:13px; padding: 8px 15px;" onclick="openModal()">
            <i class="fas fa-plus-circle"></i> Add Plan Rule
        </button>
    </div>

    <div class="action-bar">
        <button class="btn-action btn-back" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn-action btn-save" id="btnSaveMain" onclick="saveData()"><i class="fas fa-save"></i> Save Changes</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-content" style="width: 350px; padding: 20px; text-align: center;">
        <h4 style="margin-top:0; color:#d9534f;">Confirm Delete</h4>
        <p>Are you sure you want to delete this rule?</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
            <button onclick="closeConfirmModal()" style="padding:8px 20px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">No</button>
            <button id="btnConfirmDelete" style="padding:8px 20px; background:#d9534f; color:white; border:none; border-radius:4px; cursor:pointer;">Yes, Delete</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">Add Plan Criteria</span>
            <span style="cursor:pointer; font-size:18px;" onclick="closeModal()">✖</span>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                
                <div style="grid-column: span 2;" class="form-group">
                    <label>Insurance Company *</label>
                    <select id="m_ins_co">
                        <option value="">Loading Companies...</option>
                    </select>
                </div>

                <div style="grid-column: span 2;" class="form-group">
                    <label>Plan Name *</label>
                    <select id="m_plan"><option value="">Select Plan</option></select>
                </div>
                
                <div class="form-group">
                    <label>Term / PPT (Optional)</label>
                    <input type="text" id="m_term" placeholder="e.g. 21/15">
                </div>
                <div class="form-group">
                     <label>Fixed Amount (₹)</label>
                     <input type="number" id="m_fixed" value="0">
                </div>
                <div class="form-group">
                    <label>Percentage (%)</label>
                    <input type="number" id="m_percent" value="0" step="0.1">
                </div>
            </div>
            <div style="margin-top:25px; text-align:right; border-top:1px solid #eee; padding-top:15px;">
                <button onclick="closeModal()" style="background:#ccc; color:#333; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; margin-right:10px;">Cancel</button>
                <button id="modalBtnAction" onclick="addOrUpdateCriteria()" style="background:#f39c12; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">Add to List</button>
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // Use a relative path for the API base. This works for both local and production.
    // Assumes frontend and backend are on the same domain.
    const API_BASE = "";
    const params = new URLSearchParams(window.location.search);
    const dealerName = decodeURIComponent(params.get('name') || "Unknown");
    
    // Globals for Edit/Delete
    let editingRow = null;
    let rowToDelete = null;

    // ==========================================
    // 1. FIXED & SMART DATE HANDLER WITH VALIDATION
    // ==========================================
    const toISODate = (d) => {
        const now = new Date();
        const todayISO = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        if (!d || d === 'null' || d === 'undefined') {
            return todayISO;
        }

        let str = String(d).trim();

        // 1. Handle DD-MM-YYYY or DD/MM/YYYY (India Format)
        // Checks for XX-XX-XXXX where last part is 4 digits
        if (str.match(/^\d{1,2}[-/]\d{1,2}[-/]\d{4}$/)) {
            const parts = str.split(/[-/]/);
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const year = parseInt(parts[2]);

            // VALIDATION: Catch garbage like 26-20-0101
            if (month > 12 || day > 31) {
                console.warn("Invalid Date detected (Month/Day invalid):", str);
                return todayISO; // Fallback to Today
            }

            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // 2. Handle YYYY-MM-DD (ISO Format)
        if (str.match(/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/)) {
            return str.replace(/\//g, "-");
        }

        // 3. Handle 8-digit compact (e.g. 20260101 or 01012026)
        if (str.length === 8 && !isNaN(str)) {
             // If starts with 20 or 19, assume YYYYMMDD
             if(str.startsWith('20') || str.startsWith('19')) {
                 return `${str.substr(0,4)}-${str.substr(4,2)}-${str.substr(6,2)}`;
             } else {
                 // Assume DDMMYYYY
                 return `${str.substr(4,4)}-${str.substr(2,2)}-${str.substr(0,2)}`;
             }
        }
        
        // 4. Fallback: Try JS Date Parser
        const dateObj = new Date(str);
        if(!isNaN(dateObj.getTime())) {
             return dateObj.toISOString().split('T')[0];
        }

        // 5. Ultimate Fallback: Today
        return todayISO;
    };

    const selectedDate = toISODate(params.get('date'));

    // UI Display Logic (Always displays DD-MM-YYYY)
    // If date is valid ISO (YYYY-MM-DD), split gives [YYYY, MM, DD]
    const [yyyy, mm, dd] = selectedDate.split("-");
    document.getElementById('dispDate').innerText = `${dd}-${mm}-${yyyy}`;
    document.getElementById('dispName').innerText = dealerName;

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = t.className.replace("show", ""), 3000);
    }

    // --- 2. Load Masters ---
    async function loadMasters() {
        try {
            const res = await fetch(`${API_BASE}/api/master/item/licplan`); 
            const json = await res.json();
            const select = document.getElementById('m_plan');
            select.innerHTML = '<option value="">Select Plan</option>';
            const dataArray = (json && json.data && Array.isArray(json.data)) ? json.data : (Array.isArray(json) ? json : []);
            dataArray.forEach(p => {
                const planVal = p.name || p.planName || p.value;
                if(planVal) select.add(new Option(planVal, planVal));
            });
        } catch(e) { console.error("Plan load error", e); }

        try {
            const resCo = await fetch(`${API_BASE}/api/master/item/insurancecompany`); 
            const jsonCo = await resCo.json();
            const selectCo = document.getElementById('m_ins_co');
            selectCo.innerHTML = '<option value="">Select Company</option>';
            const dataArrayCo = (jsonCo && jsonCo.data && Array.isArray(jsonCo.data)) ? jsonCo.data : (Array.isArray(jsonCo) ? jsonCo : []);
            dataArrayCo.forEach(c => {
                const coName = c.companyName || c.name || c.value;
                if(coName) selectCo.add(new Option(coName, coName));
            });
        } catch(e) { console.error("Insurance Co load error", e); }
    }

    // --- 3. Modal Logic ---
    function openModal(isEdit = false) { 
        document.getElementById('addModal').style.display = 'flex'; 
        if (!isEdit) {
            editingRow = null;
            document.getElementById('modalTitle').innerText = "Add Plan Criteria";
            document.getElementById('modalBtnAction').innerText = "Add to List";
            document.getElementById('m_ins_co').value = "";
            document.getElementById('m_plan').value = "";
            document.getElementById('m_term').value = "";
            document.getElementById('m_fixed').value = "0";
            document.getElementById('m_percent').value = "0";
        } else {
            document.getElementById('modalTitle').innerText = "Edit Plan Criteria";
            document.getElementById('modalBtnAction').innerText = "Update";
        }
    }

    function closeModal() { document.getElementById('addModal').style.display = 'none'; editingRow = null; }

    function addOrUpdateCriteria() {
        const tbody = document.getElementById('tableBody');
        const insCo = document.getElementById('m_ins_co').value;
        const plan = document.getElementById('m_plan').value;
        const term = document.getElementById('m_term').value;
        const fixed = document.getElementById('m_fixed').value;
        const percent = document.getElementById('m_percent').value;

        if(!insCo) return alert("Please select an Insurance Company");
        if(!plan) return alert("Please select a Plan");

        const data = { insuranceCompany: insCo, planName: plan, termPpt: term, fixed, percent };

        if (editingRow) {
            updateRowUI(editingRow, data);
        } else {
            const row = tbody.insertRow();
            updateRowUI(row, data);
        }
        
        closeModal();
        reorder();
    }

    function updateRowUI(row, item) {
        row.innerHTML = `
            <td style="color:#777;"></td>
            <td style="font-weight:600; color:#333;">${item.insuranceCompany || '-'}</td>
            <td style="font-weight:500;">${item.planName}</td>
            <td>${item.termPpt || '-'}</td>
            <td>₹${item.fixed}</td>
            <td style="font-weight:bold; color:#f39c12;">${item.percent}%</td>
            <td class="action-cell">
                <i class="fas fa-edit edit-btn" onclick="editRow(this)" title="Edit"></i>
                <i class="fas fa-trash remove-btn" onclick="askDeleteRow(this)" title="Delete"></i>
            </td>
        `;
    }

    // --- 4. Edit & Delete ---
    function editRow(btn) {
        editingRow = btn.closest('tr');
        const cells = editingRow.cells;
        
        const insCoName = cells[1].innerText;
        const planName = cells[2].innerText;
        
        setSelectValue('m_ins_co', insCoName);
        setSelectValue('m_plan', planName);

        document.getElementById('m_term').value = cells[3].innerText === '-' ? '' : cells[3].innerText;
        document.getElementById('m_fixed').value = cells[4].innerText.replace('₹','');
        document.getElementById('m_percent').value = cells[5].innerText.replace('%','');

        openModal(true);
    }

    function setSelectValue(id, val) {
        const sel = document.getElementById(id);
        let found = false;
        for(let i=0; i<sel.options.length; i++){
            if(sel.options[i].value === val) {
                sel.selectedIndex = i;
                found = true;
                break;
            }
        }
        if(!found) {
            const opt = new Option(val, val);
            sel.add(opt);
            sel.value = val;
        }
    }

    function askDeleteRow(btn) {
        rowToDelete = btn.closest('tr');
        document.getElementById('confirmModal').style.display = 'flex';
    }

    document.getElementById('btnConfirmDelete').onclick = function() {
        if (rowToDelete) {
            rowToDelete.remove();
            reorder();
            closeConfirmModal();
        }
    };

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        rowToDelete = null;
    }

    function reorder() {
        Array.from(document.getElementById('tableBody').rows).forEach((r, i) => r.cells[0].innerText = i+1);
    }

    // --- 5. Load & Save ---
    async function loadSavedData() {
        const safeName = encodeURIComponent(dealerName);
        
        let response = await fetch(`${API_BASE}/api/expenses/lic/get-breakdown?dealerName=${safeName}&date=${selectedDate}`);
        let res = await response.json();

        if (!res || !res.data || res.data.length === 0) {
            response = await fetch(`${API_BASE}/api/expenses/lic/get-breakdown?dealerName=${safeName}&fetchLatest=true`);
            res = await response.json();
            if (res && res.data && res.data.length > 0) {
                showToast("ℹ️ Loaded previous records");
            }
        }

        if(res?.success && res.data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            res.data.forEach((item) => {
                const row = tbody.insertRow();
                updateRowUI(row, item);
            });
            reorder();
        }
    }

    async function saveData() {
        const rows = document.getElementById('tableBody').rows;
        const btn = document.getElementById('btnSaveMain');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        let items = Array.from(rows).map(r => ({
            insuranceCompany: r.cells[1].innerText,
            planName: r.cells[2].innerText,
            termPpt: r.cells[3].innerText === '-' ? '' : r.cells[3].innerText,
            fixed: Number(r.cells[4].innerText.replace('₹','').trim()),
            percent: Number(r.cells[5].innerText.replace('%','').trim())
        }));

        try {
            const res = await fetch(`${API_BASE}/api/expenses/lic/save-breakdown`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ dealerName, commissionDate: selectedDate, items })
            });
            const result = await res.json();
            
            if(result.success) {
                showToast("✅ LIC Commission Saved Successfully!");
            } else {
                alert("❌ Save failed: " + result.message);
            }
        } catch (err) {
            console.error(err);
            alert("❌ Server connection error");
        } finally {
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
    }

    loadMasters();
    loadSavedData();
</script>
</body>
</html>