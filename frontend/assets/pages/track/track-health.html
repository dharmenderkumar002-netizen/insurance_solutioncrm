<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track Health Services</title>

    <link rel="stylesheet" href="../../assets/css/gic.css"> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .page-header { background: #374151; color: white; padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; } /* Dark Grey for Health */
        .filter-card { background: white; padding: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .filter-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-col { display: flex; flex-direction: column; min-width: 150px; flex: 1; }
        .filter-col label { font-size: 12px; font-weight: 600; color: #555; margin-bottom: 5px; }
        .filter-col input, .filter-col select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%; }
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 5px; font-weight: 500;}
        .btn-go { background-color: #31708f; }
        .btn-export { background-color: #217346; }
        .table-card { background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .table-responsive { overflow-x: auto; width: 100%; height: 65vh; }
        .gic-table { width: 100%; border-collapse: collapse; min-width: 2500px; font-size: 12px; }
        .gic-table th { background: #f9f9f9; padding: 10px 8px; text-align: left; border-bottom: 2px solid #ddd; color: #333; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        .gic-table td { padding: 8px; border-bottom: 1px solid #eee; color: #555; white-space: nowrap; vertical-align: middle; }
        .col-money { text-align: right; font-family: monospace; font-weight: 600; }
        .checkbox-group { display: flex; gap: 10px; font-size: 12px; margin-top: 5px; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .st-issued { background: #d4edda; color: #155724; }
        .st-pending { background: #fff3cd; color: #856404; }
        .st-cancelled { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="page-header"><h2>Track Health Policies</h2></div>

<div class="filter-card">
    <div class="filter-row">
        <div class="filter-col">
            <label>Filter Partner</label>
            <select id="filterAgent"><option value="">-- All Partners --</option></select>
        </div>
        <div class="filter-col">
            <label>Filter Dealer</label>
            <select id="filterDealer"><option value="">-- All Dealers --</option></select>
        </div>
        <div class="filter-col" style="flex:1.5;">
            <label>Search</label>
            <input type="text" id="searchInput" placeholder="Policy No, Customer Name, Product...">
        </div>
        <div class="filter-col">
            <label>From Date</label>
            <input type="date" id="fromDate">
        </div>
        <div class="filter-col">
            <label>To Date</label>
            <input type="date" id="toDate">
        </div>
        <div class="filter-actions">
            <div class="btn-group">
                <button class="btn btn-go" onclick="loadData()">üîç Go</button>
                <button class="btn btn-export" onclick="exportToExcel()">üìä Export Excel</button>
            </div>
            <div class="checkbox-group">
                <label><input type="radio" name="filterDateType" id="chkCreated"> Created Dt</label>
                <label><input type="radio" name="filterDateType" id="chkIssue" checked> Issue Dt</label>
                <label><input type="radio" name="filterDateType" id="chkStart"> Start Dt</label>
            </div>
        </div>
    </div>
</div>

<div class="table-card">
    <div class="table-controls" style="padding: 10px;">
        <div>Search in Table: <input type="text" id="tableSearch" onkeyup="localSearch()" placeholder="Type to filter..." style="padding:4px; border:1px solid #ccc;"></div>
    </div>
    <div class="table-responsive">
        <table class="gic-table" id="dataTable">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Customer Name</th><th>Mobile</th><th>Email</th><th>Address</th><th>Partner</th>
                    <th>Policy No</th><th>Product</th><th>Type</th><th>Ins. Year</th><th>Sum Assured</th>
                    <th>Issue Date</th><th>Start Date</th><th>End Date</th>
                    <th>Ins. Company</th><th>TPA</th><th>Dealer/Source</th><th>Status</th>
                    <th class="col-money">Premium</th><th class="col-money">Net Prem</th><th class="col-money">GST</th>
                    <th>Recd Amount</th><th>Recd Date</th><th>Mode</th><th>Bank</th>
                    <th>PYP No</th><th>PYP Co</th>
                    <th>Created At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <div style="padding: 10px 15px; font-weight: bold; border-top: 1px solid #eee; text-align: right; background: #fff;">
        Total Policies: <span id="totalCount">0</span> | Total Premium: ‚Çπ<span id="totalPremium">0</span>
    </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "http://localhost:4000"; // Ensure this matches your backend port
const el = (id) => document.getElementById(id);
let allData = [];

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', async () => {
    // Set default date range (Current Month)
    const date = new Date();
    el('fromDate').value = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
    el('toDate').value = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
    
    await Promise.allSettled([loadPartners(), loadDealers()]);
    loadData(); 
});

/* ================= LOAD MASTERS ================= */
async function loadPartners() {
    try {
        const res = await fetch(`${API_BASE}/api/master/partner`);
        const json = await res.json();
        const sel = el('filterAgent');
        const list = Array.isArray(json) ? json : (json.data || []);
        list.filter(p => p.status === 'Active').forEach(p => sel.appendChild(new Option(p.name, p.name))); // Using name for filtering
    } catch(e) { console.error("Partner Load Error:", e); }
}

async function loadDealers() {
    try {
        const res = await fetch(`${API_BASE}/api/master/dealer`);
        const json = await res.json();
        const sel = el('filterDealer');
        const list = Array.isArray(json) ? json : (json.data || []);
        list.filter(d => d.status === 'Active').forEach(d => sel.appendChild(new Option(d.name, d.name)));
    } catch(e) { console.error("Dealer Load Error:", e); }
}

/* ================= LOAD DATA ================= */
async function loadData() {
    const tbody = el('tableBody');
    tbody.innerHTML = '<tr><td colspan="30" style="text-align:center; padding:20px;">Fetching Health Data...</td></tr>';

    // Determine which date field to filter by
    let dateField = 'policyIssueDate';
    if (el('chkCreated').checked) dateField = 'createdAt';
    if (el('chkStart').checked) dateField = 'startDate';

    const params = new URLSearchParams({
        partner: el('filterAgent').value,
        dealer: el('filterDealer').value,
        search: el('searchInput').value,
        from: el('fromDate').value,
        to: el('toDate').value,
        dateFilterField: dateField // Backend needs to handle this
    }).toString();

    try {
        // Ensure you create this route in backend: router.get('/track/health', ...)
        const res = await fetch(`${API_BASE}/api/health/recent?limit=1000&${params}`); 
        // Note: Using 'recent' endpoint or create a specific 'track' endpoint that accepts filters
        // For now, assuming you might modify the GET /api/health to accept filters
        
        if (!res.ok) throw new Error(`Server Error: ${res.status}`);
        
        const resData = await res.json();
        allData = Array.isArray(resData) ? resData : (resData.data || []);
        
        // Filter Client-side if backend doesn't support full filtering yet
        // (Optional: remove if backend handles it)
        const fromDate = new Date(el('fromDate').value);
        const toDate = new Date(el('toDate').value);
        
        const filteredData = allData.filter(item => {
            const itemDate = new Date(item[dateField]);
            const dateCheck = itemDate >= fromDate && itemDate <= toDate;
            
            const agentFilter = el('filterAgent').value ? item.partner === el('filterAgent').value : true;
            const dealerFilter = el('filterDealer').value ? item.dealerName === el('filterDealer').value : true;

            return dateCheck && agentFilter && dealerFilter;
        });

        renderTable(filteredData);
    } catch (err) {
        console.error("Fetch Error:", err);
        tbody.innerHTML = `<tr><td colspan="30" style="text-align:center; color:red; padding:20px;">Error: ${err.message}</td></tr>`;
    }
}

/* ================= RENDER TABLE ================= */
function renderTable(data) {
    const tbody = el('tableBody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
        el('totalCount').innerText = "0";
        el('totalPremium').innerText = "0";
        tbody.innerHTML = '<tr><td colspan="30" style="text-align:center; padding:20px;">No matching records found.</td></tr>';
        return;
    }

    let totalPrem = 0;
    const fmt = d => d ? new Date(d).toLocaleDateString('en-GB') : '-';
    const money = val => Number(val || 0).toLocaleString('en-IN', {minimumFractionDigits: 0});

    data.forEach((row, index) => {
        const premium = Number(row.premium || 0);
        totalPrem += premium;

        const custName = row.customer?.name || row.customerName || "-";
        const custMob = row.customer?.mobile || row.customerMobile || "-";
        const custEmail = row.customer?.email || row.customerEmail || "-";
        const custAddr = row.customer?.address || row.address || "-";

        // Status Badge Logic
        const status = row.status || 'Issued';
        let statusClass = 'st-issued';
        if(status === 'Pending') statusClass = 'st-pending';
        if(status === 'Cancelled') statusClass = 'st-cancelled';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            
            <td><strong>${custName}</strong></td>
            <td>${custMob}</td>
            <td>${custEmail}</td>
            <td>${custAddr}</td>
            <td>${row.partner || "-"}</td>

            <td>${row.policyNo || "-"}</td>
            <td style="color:#d35400;">${row.product || "-"}</td>
            <td>${row.policyType || "-"}</td>
            <td>${row.insuranceYear || "-"}</td>
            <td>${money(row.sumAssured)}</td>

            <td>${fmt(row.policyIssueDate)}</td>
            <td>${fmt(row.startDate)}</td>
            <td>${fmt(row.endDate)}</td>

            <td>${row.insCompany || "-"}</td>
            <td>${row.tpa || "-"}</td>
            <td>${row.dealerName || "-"}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>

            <td class="col-money" style="font-weight:bold;">${money(row.premium)}</td>
            <td class="col-money">${money(row.netPremium)}</td>
            <td class="col-money">${money((row.premium - row.netPremium).toFixed(2))}</td>

            <td class="col-money">${money(row.amountReceived?.amount)}</td>
            <td>${fmt(row.amountReceived?.date)}</td>
            <td>${row.amountReceived?.paymentMode || "-"}</td>
            <td>${row.amountReceived?.bankName || "-"}</td>

            <td>${row.previousPolicyNo || "-"}</td>
            <td>${row.pypInsCo || "-"}</td>
            
            <td>${fmt(row.createdAt)}</td>
            <td>
                <button onclick="window.location.href='../health.html'" style="cursor:pointer; border:1px solid #ccc; background:#fff; padding:2px 5px; border-radius:3px;">View</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    el('totalCount').innerText = data.length;
    el('totalPremium').innerText = totalPrem.toLocaleString('en-IN', {minimumFractionDigits: 2});
}

/* ================= SEARCH ================= */
function localSearch() {
    const query = el('tableSearch').value.toLowerCase();
    const filtered = allData.filter(row => {
        const cName = (row.customerName || row.customer?.name || "").toLowerCase();
        const pNo = (row.policyNo || "").toLowerCase();
        const prod = (row.product || "").toLowerCase();
        return cName.includes(query) || pNo.includes(query) || prod.includes(query);
    });
    renderTable(filtered);
}

/* ================= EXPORT EXCEL ================= */
async function exportToExcel() {
    if (!allData || allData.length === 0) {
        alert("‚ö†Ô∏è No data available to export! Please search first.");
        return;
    }

    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Health Report');

        // Define Columns
        worksheet.columns = [
            { header: 'S.No', key: 'sno', width: 8 },
            { header: 'Customer Name', key: 'customerName', width: 20 },
            { header: 'Mobile', key: 'mobile', width: 15 },
            { header: 'Partner', key: 'partner', width: 15 },
            { header: 'Policy No', key: 'policyNo', width: 20 },
            { header: 'Product', key: 'product', width: 20 },
            { header: 'Type', key: 'type', width: 10 },
            { header: 'Sum Assured', key: 'sumAssured', width: 15 },
            { header: 'Issue Date', key: 'issueDate', width: 15 },
            { header: 'Start Date', key: 'startDate', width: 15 },
            { header: 'End Date', key: 'endDate', width: 15 },
            { header: 'Ins. Company', key: 'insCompany', width: 20 },
            { header: 'Dealer', key: 'dealer', width: 15 },
            { header: 'TPA', key: 'tpa', width: 15 },
            { header: 'Status', key: 'status', width: 10 },
            { header: 'Total Premium', key: 'premium', width: 15 },
            { header: 'Net Premium', key: 'netPremium', width: 15 },
            { header: 'Payment Mode', key: 'mode', width: 12 },
            { header: 'Bank', key: 'bank', width: 15 },
            { header: 'PYP No', key: 'pypNo', width: 15 },
            { header: 'Created At', key: 'createdAt', width: 15 }
        ];

        const fmt = d => d ? new Date(d).toLocaleDateString('en-GB') : '-';
        const num = v => v ? Number(v) : 0;

        // Add Rows
        allData.forEach((r, index) => {
            worksheet.addRow({
                sno: index + 1,
                customerName: r.customerName || r.customer?.name || "-",
                mobile: r.customerMobile || r.customer?.mobile || "-",
                partner: r.partner || "-",
                policyNo: r.policyNo || "-",
                product: r.product || "-",
                type: r.policyType || "-",
                sumAssured: num(r.sumAssured),
                issueDate: fmt(r.policyIssueDate),
                startDate: fmt(r.startDate),
                endDate: fmt(r.endDate),
                insCompany: r.insCompany || "-",
                dealer: r.dealerName || "-",
                tpa: r.tpa || "-",
                status: r.status || "Issued",
                premium: num(r.premium),
                netPremium: num(r.netPremium),
                mode: r.amountReceived?.paymentMode || "-",
                bank: r.amountReceived?.bankName || "-",
                pypNo: r.previousPolicyNo || "-",
                createdAt: fmt(r.createdAt)
            });
        });

        // Styling (Green Header)
        const headerRow = worksheet.getRow(1);
        headerRow.eachCell((cell) => {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF374151' } // Dark Grey to match header
            };
            cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 12 };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
        });

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, `Health_Policy_Export_${new Date().toISOString().slice(0,10)}.xlsx`);

    } catch (err) {
        console.error("Export Error:", err);
        alert("Export Failed: " + err.message);
    }
}
</script>
</body>
</html>