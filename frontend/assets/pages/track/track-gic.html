<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Track GIC Services</title>

    <link rel="stylesheet" href="../assets/css/gic.css">
   
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .page-header { background: #28a745; color: white; padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; }
        .filter-card { background: white; padding: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .filter-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .filter-col { display: flex; flex-direction: column; min-width: 150px; flex: 1; }
        .filter-col label { font-size: 12px; font-weight: 600; color: #555; margin-bottom: 5px; }
        .filter-col input, .filter-col select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%; }
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 5px; font-weight: 500;}
        .btn-go { background-color: #31708f; }
        .btn-export { background-color: #217346; }
        .table-card { background: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .table-responsive { overflow-x: auto; width: 100%; height: 65vh; }
        .gic-table { width: 100%; border-collapse: collapse; min-width: 2500px; font-size: 12px; }
        .gic-table th { background: #f9f9f9; padding: 10px 8px; text-align: left; border-bottom: 2px solid #ddd; color: #333; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        .gic-table td { padding: 8px; border-bottom: 1px solid #eee; color: #555; white-space: nowrap; vertical-align: middle; }
        .col-money { text-align: right; font-family: monospace; font-weight: 600; }
        .checkbox-group { display: flex; gap: 10px; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="page-header"><h2>New GIC Services Tracking</h2></div>

<div class="filter-card">
    <div class="filter-row">
        <div class="filter-col">
            <label>Filter Agent</label>
            <select id="filterAgent"><option value="">-- All Agents --</option></select>
        </div>
        <div class="filter-col">
            <label>Filter Dealer</label>
            <select id="filterDealer"><option value="">-- All Dealers --</option></select>
        </div>
        <div class="filter-col" style="flex:1.5;">
            <label>Search</label>
            <input type="text" id="searchInput" placeholder="Policy No, Vehicle, Customer Name...">
        </div>
        <div class="filter-col">
            <label>From Date</label>
            <input type="date" id="fromDate">
        </div>
        <div class="filter-col">
            <label>To Date</label>
            <input type="date" id="toDate">
        </div>
        <div class="filter-actions">
            <div class="btn-group">
                <button class="btn btn-go" onclick="loadData()">üîç Go</button>
                <button class="btn btn-export" onclick="exportToExcel()">üìä Export Excel</button>
            </div>
            <div class="checkbox-group">
                <label><input type="radio" name="filterDateType" id="chkCreated"> By Created Dt</label>
                <label><input type="radio" name="filterDateType" id="chkPolicy" checked> By Policy Dt</label>
            </div>
        </div>
    </div>
</div>

<div class="table-card">
    <div class="table-controls" style="padding: 10px;">
        <div>Search in Table: <input type="text" id="tableSearch" onkeyup="localSearch()" placeholder="Type to filter..." style="padding:4px; border:1px solid #ccc;"></div>
    </div>
    <div class="table-responsive">
        <table class="gic-table" id="dataTable">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Customer Name</th><th>Mobile</th><th>Email</th><th>Address</th><th>Partner</th>
                    <th>Policy No</th><th>Policy Type</th><th>Coverage</th><th>FY</th><th>Policy Issue Date</th>
                    <th>Vehicle No</th><th>Vehicle Name</th><th>Reg Date</th><th>Fuel</th><th>CC/GVW</th><th>NCB (%)</th><th>Class</th><th>Chassis No</th><th>Engine No</th>
                    <th>OD Start</th><th>OD End</th><th>TP Start</th><th>TP End</th>
                    <th>Dealer</th><th>Ins. Company</th><th>Product</th><th>Trailor</th><th>PA Taxi</th>
                    <th class="col-money">IDV</th><th class="col-money">OD Prem</th><th class="col-money">Discount</th><th class="col-money">Net Prem</th><th class="col-money">Total Prem</th>
                    <th class="col-money">PA Owner</th><th class="col-money">PA Pass.</th>
                    <th>Recd Date</th><th>Mode</th><th>Cheque/Ref</th><th>Bank</th>
                    <th>PYP No</th><th>PYP Co</th><th>PYP End Date</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <div style="padding: 10px 15px; font-weight: bold; border-top: 1px solid #eee; text-align: right; background: #fff;">
        Total Records: <span id="totalCount">0</span> | Total Balance: ‚Çπ<span id="totalBalance">0</span>
    </div>
</div>

<script>
const API_BASE = "http://localhost:4000";
const el = (id) => document.getElementById(id);
let allData = [];

document.addEventListener('DOMContentLoaded', async () => {
    const date = new Date();
    el('fromDate').value = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
    el('toDate').value = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
    
    await Promise.allSettled([loadAgents(), loadDealers()]);
    loadData(); 
});

async function loadAgents() {
    try {
        const res = await fetch(`${API_BASE}/api/master/partner`);
        const json = await res.json();
        const sel = el('filterAgent');
        const list = Array.isArray(json) ? json : (json.data || []);
        list.filter(p => p.status === 'Active').forEach(p => sel.appendChild(new Option(p.name, p._id)));
    } catch(e) { console.error("Agent Load Error:", e); }
}

async function loadDealers() {
    try {
        const res = await fetch(`${API_BASE}/api/master/dealer`);
        const json = await res.json();
        const sel = el('filterDealer');
        const list = Array.isArray(json) ? json : (json.data || []);
        list.filter(d => d.status === 'Active').forEach(d => sel.appendChild(new Option(d.name, d.name)));
    } catch(e) { console.error("Dealer Load Error:", e); }
}

async function loadData() {
    const tbody = el('tableBody');
    tbody.innerHTML = '<tr><td colspan="45" style="text-align:center; padding:20px;">Fetching Data...</td></tr>';

    const dateFilterField = el('chkPolicy').checked ? 'policyIssueDate' : 'createdAt';

    const params = new URLSearchParams({
        partner: el('filterAgent').value,
        dealer: el('filterDealer').value,
        search: el('searchInput').value,
        from: el('fromDate').value,
        to: el('toDate').value,
        dateFilterField: dateFilterField
    }).toString();

    try {
        const res = await fetch(`${API_BASE}/api/track/gic?${params}`);
        if (!res.ok) throw new Error(`Server Error: ${res.status}`);
        
        const resData = await res.json();
        allData = Array.isArray(resData) ? resData : (resData.data || []);
        
        renderTable(allData);
    } catch (err) {
        console.error("Fetch Error:", err);
        tbody.innerHTML = `<tr><td colspan="45" style="text-align:center; color:red; padding:20px;">Error: ${err.message}</td></tr>`;
    }
}

function renderTable(data) {
    const tbody = el('tableBody');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
        el('totalCount').innerText = "0";
        el('totalBalance').innerText = "0";
        tbody.innerHTML = '<tr><td colspan="45" style="text-align:center; padding:20px;">No matching data found.</td></tr>';
        return;
    }

    let totalBal = 0;
    const fmt = d => d ? new Date(d).toLocaleDateString('en-GB') : '-';
    // Helper to format money (0 ko bhi show kare agar data hai, nahi to 0)
    const money = val => Number(val).toLocaleString('en-IN', {minimumFractionDigits: 0});

    data.forEach((row, index) => {
        const prem = Number(row.premium || 0);
        const recd = Number(row.receivedAmount || 0);
        const bal = Number(row.balance || 0);
        totalBal += bal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            
            <td><strong>${row.customerName}</strong></td>
            <td>${row.customerMobile}</td>
            <td>${row.customerEmail}</td>
            <td>${row.address}</td>
            <td>${row.agentName}</td>

            <td>${row.policyNo}</td>
            <td>${row.policyType}</td>
            <td>${row.coverageType}</td>
            <td>${row.insuranceYear}</td>
            <td>${fmt(row.policyIssueDate)}</td>

            <td style="color:#0056b3; font-weight:bold;">${row.vehicleNo}</td>
            <td>${row.vehicleName}</td>
            <td>${fmt(row.vehicleRegDate)}</td>
            <td>${row.fuel}</td>
            <td>${row.ccKwGvw}</td>
            <td style="font-weight:bold; color:#2e7d32;">${row.ncb ?? 0}%</td>
            <td>${row.vehicleClass}</td>
            <td>${row.chassisNo}</td>
            <td>${row.engineNo}</td>

            <td>${fmt(row.odStartDate)}</td>
            <td>${fmt(row.odEndDate)}</td>
            <td>${fmt(row.tpStartDate)}</td>
            <td>${fmt(row.tpEndDate)}</td>

            <td>${row.dealerName}</td>
            <td>${row.insuranceCompany}</td>
            <td style="color:#d35400;">${row.productName}</td>
            <td>${row.trailorType}</td>
            <td>${money(row.paTaxi)}</td>

            <td class="col-money">${money(row.idv)}</td>
            <td class="col-money">${money(row.odPremium)}</td>
            <td class="col-money">${money(row.discount)}</td>
            <td class="col-money">${money(row.netPremium)}</td>
            <td class="col-money" style="font-weight:bold;">${money(row.premium)}</td>

            <td class="col-money">${money(row.pa)}</td>
            <td class="col-money">${money(row.patopass)}</td>

            <td>${fmt(row.receivedDate)}</td>
            <td>${row.paymentMode}</td>
            <td>${row.chequeDetails}</td>
            <td>${row.bankName}</td>

            <td>${row.previousPolicyNo}</td>
            <td>${row.pypInsCo}</td>
            <td>${fmt(row.pypEndDate)}</td>

            <td>${fmt(row.createdAt)}</td>
        `;
        tbody.appendChild(tr);
    });

    el('totalCount').innerText = data.length;
    el('totalBalance').innerText = totalBal.toLocaleString('en-IN', {minimumFractionDigits: 2});
}

function localSearch() {
    const query = el('tableSearch').value.toLowerCase();
    const filtered = allData.filter(row => 
        row.customerName.toLowerCase().includes(query) ||
        row.vehicleNo.toLowerCase().includes(query) ||
        row.policyNo.toLowerCase().includes(query) ||
        row.chassisNo.toLowerCase().includes(query)
    );
    renderTable(filtered);
}

async function exportToExcel() {
    if (!allData || allData.length === 0) {
        alert("‚ö†Ô∏è No data available to export! Please search first.");
        return;
    }

    try {
        // 1. Create a new Workbook and Worksheet
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('GIC Report');

        // 2. Define Columns (Headers & Keys)
        worksheet.columns = [
            { header: 'S.No', key: 'sno', width: 8 },
            { header: 'Customer Name', key: 'customerName', width: 20 },
            { header: 'Mobile', key: 'customerMobile', width: 15 },
            { header: 'Email', key: 'customerEmail', width: 25 },
            { header: 'Address', key: 'address', width: 25 },
            { header: 'Partner/Agent', key: 'agentName', width: 15 },
            { header: 'Policy No', key: 'policyNo', width: 20 },
            { header: 'Policy Type', key: 'policyType', width: 15 },
            { header: 'Coverage', key: 'coverageType', width: 15 },
            { header: 'Ins. Year', key: 'insuranceYear', width: 10 },
            { header: 'Issue Date', key: 'policyIssueDate', width: 15 },
            { header: 'Vehicle No', key: 'vehicleNo', width: 15 },
            { header: 'Vehicle Name', key: 'vehicleName', width: 20 },
            { header: 'Reg Date', key: 'vehicleRegDate', width: 15 },
            { header: 'Fuel', key: 'fuel', width: 10 },
            { header: 'CC/GVW', key: 'ccKwGvw', width: 10 },
            { header: 'NCB (%)', key: 'ncb', width: 10 },
            { header: 'Class', key: 'vehicleClass', width: 15 },
            { header: 'Chassis No', key: 'chassisNo', width: 20 },
            { header: 'Engine No', key: 'engineNo', width: 20 },
            { header: 'OD Start', key: 'odStartDate', width: 15 },
            { header: 'OD End', key: 'odEndDate', width: 15 },
            { header: 'TP Start', key: 'tpStartDate', width: 15 },
            { header: 'TP End', key: 'tpEndDate', width: 15 },
            { header: 'Dealer', key: 'dealerName', width: 15 },
            { header: 'Ins. Company', key: 'insuranceCompany', width: 15 },
            { header: 'Product', key: 'productName', width: 15 },
            { header: 'Trailor', key: 'trailorType', width: 10 },
            { header: 'PA Taxi', key: 'paTaxi', width: 12 },
            { header: 'IDV', key: 'idv', width: 15 },
            { header: 'OD Premium', key: 'odPremium', width: 15 },
            { header: 'Discount', key: 'discount', width: 12 },
            { header: 'Net Premium', key: 'netPremium', width: 15 },
            { header: 'Total Premium', key: 'premium', width: 15 },
            { header: 'PA Owner', key: 'pa', width: 12 },
            { header: 'PA Pass.', key: 'patopass', width: 12 },
            { header: 'Recd Date', key: 'receivedDate', width: 15 },
            { header: 'Mode', key: 'paymentMode', width: 12 },
            { header: 'Cheque/Ref', key: 'chequeDetails', width: 20 },
            { header: 'Bank', key: 'bankName', width: 15 },
            { header: 'Prev. Pol No', key: 'previousPolicyNo', width: 20 },
            { header: 'Prev. Co', key: 'pypInsCo', width: 15 },
            { header: 'Prev. End', key: 'pypEndDate', width: 15 },
            { header: 'Created At', key: 'createdAt', width: 15 },
            { header: 'Balance', key: 'balance', width: 15 }
        ];

        // 3. Helpers
        const fmt = d => d ? new Date(d).toLocaleDateString('en-GB') : '-';
        const num = v => v ? Number(v) : 0;

        // 4. Add Rows
        allData.forEach((r, index) => {
            worksheet.addRow({
                sno: index + 1,
                customerName: r.customerName || "-",
                customerMobile: r.customerMobile || "-",
                customerEmail: r.customerEmail || "-",
                address: r.address || "-",
                agentName: r.agentName || "-",
                policyNo: r.policyNo || "-",
                policyType: r.policyType || "-",
                coverageType: r.coverageType || "-",
                insuranceYear: r.insuranceYear || "-",
                policyIssueDate: fmt(r.policyIssueDate),
                vehicleNo: r.vehicleNo || "-",
                vehicleName: r.vehicleName || "-",
                vehicleRegDate: fmt(r.vehicleRegDate),
                fuel: r.fuel || "-",
                ccKwGvw: r.ccKwGvw || "-",
                ncb: r.ncb ?? 0,          // ‚úÖ FINAL EXCEL FIX
                vehicleClass: r.vehicleClass || "-",
                chassisNo: r.chassisNo || "-",
                engineNo: r.engineNo || "-",
                odStartDate: fmt(r.odStartDate),
                odEndDate: fmt(r.odEndDate),
                tpStartDate: fmt(r.tpStartDate),
                tpEndDate: fmt(r.tpEndDate),
                dealerName: r.dealerName || "-",
                insuranceCompany: r.insuranceCompany || "-",
                productName: r.productName || "-",
                trailorType: r.trailorType || "-",
                paTaxi: num(r.paTaxi),
                idv: num(r.idv),
                odPremium: num(r.odPremium),
                discount: num(r.discount),
                netPremium: num(r.netPremium),
                premium: num(r.premium),
                pa: num(r.pa),
                patopass: num(r.patopass),
                receivedDate: fmt(r.receivedDate),
                paymentMode: r.paymentMode || "-",
                chequeDetails: r.chequeDetails || "-",
                bankName: r.bankName || "-",
                previousPolicyNo: r.previousPolicyNo || "-",
                pypInsCo: r.pypInsCo || "-",
                pypEndDate: fmt(r.pypEndDate),
                createdAt: fmt(r.createdAt),
                balance: num(r.balance)
            });
        });

        // 5. STYLING (The Magic Part) ‚ú®
        
        // Header Row Styling
        const headerRow = worksheet.getRow(1);
        headerRow.eachCell((cell) => {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF28A745' } // Green Color (ARGB)
            };
            cell.font = {
                color: { argb: 'FFFFFFFF' }, // White Text
                bold: true,
                size: 12
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'medium' },
                right: { style: 'thin' }
            };
        });

        // Data Rows Styling
        worksheet.eachRow((row, rowNumber) => {
            if (rowNumber > 1) { // Skip header
                row.eachCell((cell, colNumber) => {
                    // Common Border
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                        right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                    };

                    // Specific Styling for Amount Columns (Right Align + Bold)
                    // Columns: IDV(29) to TotalPrem(33), Balance(44)
                    const moneyCols = [28,29,30,31,32,33,34,35, 44];
                    if (moneyCols.includes(colNumber)) {
                        cell.alignment = { horizontal: 'right' };
                        cell.font = { bold: true };
                        // cell.numFmt = '‚Çπ#,##0'; // Optional: Add Rupee symbol
                    } else {
                        cell.alignment = { horizontal: 'left' };
                    }
                });
            }
        });

        // 6. Generate & Download
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, `GIC_CRM_Color_Export_${new Date().toISOString().slice(0,10)}.xlsx`);

    } catch (err) {
        console.error("Export Error:", err);
        alert("Export Failed: " + err.message);
    }
}
</script>
</body>
</html>