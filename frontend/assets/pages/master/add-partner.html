<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Add Partner</title>

<link rel="stylesheet" href="/assets/css/sidebar.css">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/forms.css">

<style>
    body {
        font-family: Arial;
        background: #f4f6f9;
        padding: 18px;
    }

    .box {
        background: #ffffff;
        padding: 25px;
        border-radius: 12px;
        max-width: 900px;
        margin: 0 auto 25px auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h2, h3 {
        color: #1e293b;
        font-weight: 600;
        margin-bottom: 15px;
    }

    /* ===== 2 COLUMN GRID ===== */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .full {
        grid-column: span 2;
    }

    label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #475569;
        font-size: 14px;
    }

    input, select {
        width: 100%;
        padding: 9px 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: #f8fafc;
        font-size: 14px;
        color: #0f172a;
    }

    .btn {
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 20px;
    }

    .btn:hover {
        background: #1d4ed8;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        font-size: 14px;
    }

    thead th {
        background: #f1f5f9;
        color: #1e293b;
    }

    .edit, .del {
        padding: 6px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: #fff;
        margin-right: 5px;
        font-size: 13px;
    }

    .edit { background: #10b981; }
    .del { background: #ef4444; }

    /* Mobile */
    @media (max-width: 640px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        .full {
            grid-column: span 1;
        }
    }
</style>
</head>

<body onload="initPage()">

<!-- ================= FORM ================= -->
<div class="box">
    <h2>Add Partner</h2>

    <div class="form-grid">

        <div>
            <label>S.No *</label>
            <input id="sno" readonly>
        </div>

        <div>
            <label>Date</label>
            <input id="date" readonly>
        </div>

        <div class="full">
            <label>Partner Name *</label>
            <input id="partnername">
        </div>

        <div>
            <label>Mobile *</label>
            <input id="mobile">
        </div>

        <div>
            <label>Email</label>
            <input id="email">
        </div>

        <div>
            <label>In / Out *</label>
            <select id="inout">
                <option value="In">In</option>
                <option value="Out">Out</option>
            </select>
        </div>

        <div>
            <label>Status *</label>
            <select id="status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>

    </div>

    <button class="btn" onclick="savePartner()">Save Partner</button>
</div>

<!-- ================= TABLE ================= -->
<div class="box">
    <h3>Partner Records</h3>
    <table>
        <thead>
            <tr>
                <th>S.No</th>
                <th>Name</th>
                <th>Mobile</th>
                <th>Email</th>
                <th>In/Out</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
const API = "/api/master/partner";
let isEditMode = false;
let currentEditId = null;

function loadDate(){
    document.getElementById("date").value =
        new Date().toISOString().split("T")[0];
}

async function loadSno(){
    try {
        const res = await fetch(API);
        const json = await res.json();
        document.getElementById("sno").value =
            (json.data ? json.data.length : 0) + 1;
    } catch {
        document.getElementById("sno").value = "1";
    }
}

async function savePartner() {
    const btn = document.querySelector('.btn');
    const payload = {
        partnername: document.getElementById('partnername').value,
        mobile: document.getElementById('mobile').value,
        email: document.getElementById('email').value,
        inout: document.getElementById('inout').value,
        status: document.getElementById('status').value,
        date: document.getElementById('date').value
    };

    if(!payload.partnername || !payload.mobile){
        alert("Please fill Name and Mobile!");
        return;
    }

    const url = isEditMode ? `${API}/${currentEditId}` : `${API}/save`;
    const method = isEditMode ? 'PUT' : 'POST';

    btn.innerText = "Processing...";

    try {
        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        if(result.success){
            alert(isEditMode ? "Updated Successfully!" : "Saved Successfully!");
            location.reload();
        } else {
            alert(result.message || "Error");
            btn.innerText = isEditMode ? "Update Partner" : "Save Partner";
        }
    } catch {
        alert("Server Error");
        btn.innerText = isEditMode ? "Update Partner" : "Save Partner";
    }
}

async function loadList(){
    const res = await fetch(API);
    const json = await res.json();
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if(json.data && json.data.length){
        json.data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.s_no}</td>
                    <td>${p.name}</td>
                    <td>${p.mobile}</td>
                    <td>${p.email}</td>
                    <td>${p.inout}</td>
                    <td>${p.status}</td>
                    <td>${p.date}</td>
                    <td>
                        <button class="edit" onclick="editPartner('${p._id}')">Edit</button>
                        <button class="del" onclick="delPartner('${p._id}')">Del</button>
                    </td>
                </tr>`;
        });
    } else {
        tbody.innerHTML =
            `<tr><td colspan="8" style="text-align:center;">No records found.</td></tr>`;
    }
}

async function editPartner(id){
    const res = await fetch(API);
    const json = await res.json();
    const p = json.data.find(x => x._id === id);

    if(!p) return;

    isEditMode = true;
    currentEditId = id;

    document.getElementById("partnername").value = p.name || "";
    document.getElementById("mobile").value = p.mobile || "";
    document.getElementById("email").value = p.email || "";
    document.getElementById("inout").value = p.inout || "In";
    document.getElementById("status").value = p.status || "Active";

    document.querySelector(".btn").innerText = "Update Partner";
    window.scrollTo(0,0);
}

async function delPartner(id){
    if(!confirm("Delete this partner?")) return;
    await fetch(`${API}/${id}`, { method: "DELETE" });
    location.reload();
}

function initPage(){
    loadDate();
    loadSno();
    loadList();
}
</script>

</body>
</html>
