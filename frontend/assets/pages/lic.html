<!DOCTYPE html>
<html lang="en">
<head>
<script>
    // Redirect to main layout if not in an iframe.
    // This prevents direct access to the page.
    if (window.self === window.top) {
        // The path to layout.html from this page.
        window.location.href = 'layout.html';
    }
</script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LIC Policy Entry</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/gic.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --toast-z-index: 9999; }
        * { box-sizing: border-box; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: var(--toast-z-index); }
        .toast { background: #333; color: white; padding: 12px 16px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; animation: slideIn 0.3s ease-out; }
        .toast.error { background: #d9534f; }
        .toast.success { background: #5cb85c; }
        .toast.warning { background: #f0ad4e; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .smart-suggestion-box { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ccc; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none; }
        .smart-suggestion-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .smart-suggestion-item:hover { background-color: #e3f2fd; }
        .no-record { padding: 10px; color: #d9534f; text-align: center; }
        .attachment-btn { padding: 8px; background: #6c757d; color: white; border-radius: 4px; cursor: pointer; width: 100%; text-align: center; }
        .attachment-btn:hover { background: #5a6268; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="sidebar">
    <div class="logo"><img src="../assets/images/logo.png" alt="logo"></div>
    <a href="home.html">üè† Home</a>
    <a href="gic.html">üõ† GIC</a>
    <a href="lic.html" style="background:#374151">üéØ LIC</a>
    <a href="health.html">‚ù§Ô∏è Health</a>
    <a href="nonmotor.html">üöò Non Motor</a>
    <a href="track/track-all.html">üìä Track Service</a>
    <a href="master/add-partner.html">‚öô Master</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<div class="page-content">
    <h2>LIC Policy Entry</h2>
    <input type="hidden" id="licId">

    <div class="crm-card">
        <h3>Customer</h3>
        <div class="form-row" style="align-items: flex-end;">
            <div class="form-col" style="position: relative; z-index: 101; flex: 2;">
                <label for="searchBox">Search Customer (Name, Mobile)</label>
                <input id="searchBox" placeholder="Start typing..." autocomplete="off">
            </div>
            <div class="form-col" style="flex: 0 0 150px; margin-bottom: 0;">
                <button type="button" class="crm-button-accent crm-button-small" onclick="openCustomerPopup()">üë§ + Add New</button>
            </div>
        </div>
        <input type="hidden" id="customerId">
        <div class="form-row">
            <div class="form-col"><label>Name</label><input id="customerName" readonly></div>
            <div class="form-col"><label>Mobile</label><input id="customerMobile" readonly></div>
            <div class="form-col"><label>Partner</label><select id="partner"></select></div>
        </div>
    </div>

    <div class="crm-card">
        <h3>Policy Details</h3>
        <div class="form-row">
            <div class="form-col"><label for="licPlan">LIC Plan *</label><select id="licPlan"></select></div>
            <div class="form-col"><label for="policyNo">Policy No *</label><input id="policyNo"></div>
            <div class="form-col"><label for="policyIssueDate">Policy Issue Date *</label><input type="date" id="policyIssueDate"></div>
            <div class="form-col"><label for="startDate">Start Date *</label><input type="date" id="startDate"></div>
            <div class="form-col"><label for="maturityDate">Maturity Date</label><input type="date" id="maturityDate"></div>
             <div class="form-col"><label for="payMode">Pay Mode *</label><select id="payMode"><option value="YLY">YLY</option><option value="HLY">HLY</option><option value="QLY">QLY</option><option value="MLY">MLY</option><option value="SINGLE">SINGLE</option></select></div>
        </div>
        <div class="form-row">
            <div class="form-col"><label for="sumAssured">Sum Assured</label><input type="number" id="sumAssured"></div>
            <div class="form-col"><label for="premium">Premium *</label><input type="number" id="premium"></div>
            <div class="form-col"><label for="netPremium">Net Premium</label><input type="number" id="netPremium"></div>
            <div class="form-col" style="position:relative;">
                <label for="dealerName" style="color:#b7791f;">Dealer (Payout) *</label>
                <input id="dealerName" placeholder="Select dealer..." autocomplete="off" style="border-color:#ffeeba; background:#fffdf5;">
            </div>
            <div class="form-col">
                <label for="insCompany">Insurance Co *</label>
                <input id="insCompany" placeholder="Auto-filled by dealer..." value="Life Insurance Corporation of India">
            </div>
            <div class="form-col"><label for="status">Policy Status</label><select id="status"><option value="Issued">Issued</option><option value="Pending">Pending</option><option value="Cancelled">Cancelled</option></select></div>
        </div>
    </div>
    
    <div class="crm-card">
        <h3>Payment & Documentation</h3>
        <div class="form-row">
            <div class="form-col"><label for="premiumamt">Premium Amt *</label><input id="premiumamt" type="number" placeholder="Premium Amount"></div>
            <div class="form-col"><label for="amountDate">Amount Received Date</label><input type="date" id="amountDate"></div>
            <div class="form-col"><label for="paymentMode">Payment Mode</label><select id="paymentMode"></select></div>
            <div class="form-col"><label for="chequeDd">Cheque / UPI Ref</label><input id="chequeDd"></div>
            <div class="form-col"><label for="bankName">Bank Name</label><select id="bankName"></select></div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 25px;">
        <button onclick="saveLIC()" type="button" class="crm-button-primary" style="min-width: 250px;">üíæ Save LIC Entry</button>
    </div>

    <div class="crm-card" style="margin-top:30px;">
        <h3>Recent LIC Records</h3>
        <table class="crm-table" style="width:100%;">
            <thead>
                <tr>
                    <th>Customer</th><th>Policy No</th><th>Plan</th><th>Premium</th><th>Start Date</th><th>Status</th><th>Action</th>
                </tr>
            </thead>
            <tbody id="recentLISTableBody"></tbody>
        </table>
    </div>
</div>

<script src="../js/auth.js"></script>
<script>
    // Use a relative path for the API base. This works for both local and production.
    // Assumes frontend and backend are on the same domain.
const API_BASE = "";

// Standard date helpers
const getSafeDate = (dateString) => dateString || null;
const getStandardDate = (mongoDate) => mongoDate ? new Date(mongoDate).toISOString().split("T")[0] : "";

function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

const el = id => document.getElementById(id);
const val = id => el(id)?.value.trim() || '';

// ===========================================
// DATA LOADING
// ===========================================
async function fetchJson(url) {
    try {
        const res = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    } catch (err) {
        showToast(`API Error: ${err.message}`, 'error');
        return null;
    }
}

async function loadDropdown(url, elementId, keyName, valueName = null) {
    const json = await fetchJson(url);
    const select = el(elementId);
    if (!select) return;
    select.innerHTML = '<option value="">-- Select --</option>';
    const items = json?.data || json || [];
    items.forEach(item => {
        if (item.status !== "Inactive") {
            const text = item[keyName] || item.name;
            const value = valueName ? item[valueName] : text;
            if (text) select.options[select.options.length] = new Option(text, value);
        }
    });
}

// ===========================================
// CUSTOMER LOGIC (Search, Popup, Fill)
// ===========================================
function initSearchLogic() {
    const searchInput = el('searchBox');
    const searchResults = document.createElement('div');
    searchResults.style.position = 'absolute';
    searchResults.style.top = '100%';
    searchResults.style.left = 0;
    searchResults.style.zIndex = 100;
    searchResults.style.backgroundColor = 'white';
    searchResults.style.border = '1px solid #ccc';
    searchResults.style.width = '100%';
    searchInput.parentNode.appendChild(searchResults);

    searchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        if (query.length < 2) {
            searchResults.innerHTML = '';
            searchResults.style.display = 'none';
            return;
        }
        
        try {
            const res = await fetch(`${API_BASE}/api/gic/autocomplete?q=${query}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            
            if (data.customers && data.customers.length > 0) {
                data.customers.forEach(cust => {
                    const div = document.createElement('div');
                    div.style.padding = '8px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.textContent = `${cust.name} (${cust.mobile})`;
                    div.onmouseover = () => div.style.backgroundColor = '#f0f0f0';
                    div.onmouseout = () => div.style.backgroundColor = 'white';
                    div.onmousedown = () => {
                        fillCustomerData(cust);
                        searchInput.value = '';
                        searchResults.style.display = 'none';
                    };
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        } catch (err) {
            console.error("Search Error:", err);
        }
    });

    document.addEventListener('click', (e) => {
        if (e.target !== searchInput) {
            searchResults.style.display = 'none';
        }
    });
}

function openCustomerPopup() {
    window.open("universal-customer.html", "CustPopup", "width=550,height=700");
}
window.addEventListener("message", (e) => {
    if (e.data?.type === 'CUSTOMER_SAVED') {
        fillCustomerData(e.data.payload);
        showToast(`Customer Selected: ${e.data.payload.name}`, "success");
    }
});

function fillCustomerData(c) {
    el('customerId').value = c._id;
    el('customerName').value = c.name;
    el('customerMobile').value = c.mobile;
    if (c.partner) {
        // Attempt to select partner by name
        const partnerSelect = el('partner');
        for (let i = 0; i < partnerSelect.options.length; i++) {
            if (partnerSelect.options[i].text === c.partner) {
                partnerSelect.selectedIndex = i;
                break;
            }
        }
    }
}


// ===========================================
// DEALER SUGGESTION LOGIC
// ===========================================
const dealerInput = el('dealerName');
const dealerBox = document.createElement('div');
dealerBox.className = 'smart-suggestion-box';
dealerInput.parentNode.appendChild(dealerBox);
let cachedDealers = [];

async function initDealerLogic() {
    // 1. Fetch dealers on focus if needed
    dealerInput.addEventListener('focus', async () => {
        if (!val('licPlan')) return showToast("Select a Plan first.", 'warning');
        if (!val('startDate')) return showToast("Select a Start Date first.", 'warning');
        
        dealerBox.style.display = 'block';
        if (cachedDealers.length === 0) {
            dealerBox.innerHTML = '<div style="padding:10px;">Loading...</div>';
            // ‚úÖ Use the new, correct endpoint
            const res = await fetchJson(`${API_BASE}/api/expenses/lic/all-rules`);
            cachedDealers = res?.data || [];
        }
        renderDealerSuggestions(dealerInput.value);
    });
    
    // 2. Filter on input
    dealerInput.addEventListener('input', e => renderDealerSuggestions(e.target.value));
    
    // 3. Hide on blur
    dealerInput.addEventListener('blur', () => setTimeout(() => dealerBox.style.display='none', 250));

    // 4. Reset on change
    el('licPlan').addEventListener('change', () => { el('dealerName').value = ''; el('insCompany').value = 'Life Insurance Corporation of India'; });
    el('startDate').addEventListener('change', () => { if (val('dealerName')) renderDealerSuggestions(val('dealerName')); });
}

function renderDealerSuggestions(filterText = '') {
    const selectedPlan = val('licPlan').toLowerCase();
    const riskDateStr = val('startDate');
    if (!selectedPlan || !riskDateStr) return;

    const riskDate = new Date(riskDateStr);
    riskDate.setHours(0,0,0,0); // Normalize risk date
    dealerBox.innerHTML = '';
    
    const candidates = cachedDealers
        .map(record => ({
            ...record,
            // Ensure date is a valid Date object for comparison
            effectiveDate: new Date(record.commissionDate.substring(4, 8), record.commissionDate.substring(2, 4) - 1, record.commissionDate.substring(0, 2))
        }))
        .filter(record => record.effectiveDate <= riskDate) // Rule must be effective
        .flatMap(record => 
            (record.items || []) // Use 'items' array from the model
            .filter(rule => (rule.planName || '').toLowerCase() === selectedPlan)
            .map(rule => ({
                dealerName: record.dealerName,
                company: rule.insuranceCompany || 'Life Insurance Corporation of India',
                effectiveDate: record.effectiveDate
            }))
        )
        .filter(c => c.dealerName.toLowerCase().includes(filterText.toLowerCase()))
        .sort((a,b) => b.effectiveDate - a.effectiveDate); // Newest rules first

    const uniqueCandidates = [...new Map(candidates.map(c => [`${c.dealerName}-${c.company}`, c])).values()];
    
    if (uniqueCandidates.length === 0) {
        dealerBox.innerHTML = `<div class="no-record">No payout rule found for this plan and date.</div>`;
        return;
    }

    uniqueCandidates.forEach(item => {
        const div = document.createElement('div');
        div.className = 'smart-suggestion-item';
        div.innerHTML = `<b>${item.dealerName}</b> <span style="color:#007bff;">${item.company}</span>`;
        div.onmousedown = () => {
            el('dealerName').value = item.dealerName;
            el('insCompany').value = item.company;
            dealerBox.style.display = 'none';
        };
        dealerBox.appendChild(div);
    });
}

// ===========================================
// SAVE / UPDATE / DELETE
// ===========================================
async function saveLIC() {
    const payload = {
        customerId: val('customerId'),
        customerName: val('customerName'),
        partner: val('partner'),
        planName: val('licPlan'),
        policyNo: val('policyNo'),
        policyIssueDate: getSafeDate(val('policyIssueDate')),
        startDate: getSafeDate(val('startDate')),
        maturityDate: getSafeDate(val('maturityDate')),
        payMode: val('payMode'),
        sumAssured: val('sumAssured'),
        premium: val('premium'),
        netPremium: val('netPremium'),
        dealerName: val('dealerName'),
        insCompany: val('insCompany'),
        status: val('status'),
        amountReceived: {
            amount: val('premiumamt'),
            date: getSafeDate(val('amountDate')),
            paymentMode: val('paymentMode'),
            chequeDd: val('chequeDd'),
            bankName: val('bankName')
        }
    };

    if (!payload.policyNo || !payload.customerName) {
        return showToast("Customer and Policy No are required.", "warning");
    }

    const id = val('licId');
    const url = id ? `${API_BASE}/api/lic/${id}` : `${API_BASE}/api/lic`;
    const method = id ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        showToast(`LIC Policy ${id ? 'Updated' : 'Saved'}!`, 'success');
        resetForm();
        loadRecentLIC();
    } catch(err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

function resetForm() {
    el('licId').value = '';
    document.querySelector('.page-content').querySelectorAll('input, select').forEach(input => {
        if(input.id !== 'searchBox') input.value = '';
    });
    el('insCompany').value = 'Life Insurance Corporation of India';
    el('status').value = 'Issued';
}

async function editLIC(id) {
    const result = await fetchJson(`${API_BASE}/api/lic/${id}`);
    if (!result?.success) return showToast('Failed to load record.', 'error');
    const d = result.data;
    
    el('licId').value = d._id;
    if (d.customer) fillCustomerData(d.customer);
    
    el('partner').value = d.partner;
    el('licPlan').value = d.planName;
    el('policyNo').value = d.policyNo;
    el('policyIssueDate').value = getStandardDate(d.policyIssueDate);
    el('startDate').value = getStandardDate(d.startDate);
    el('maturityDate').value = getStandardDate(d.maturityDate);
    el('payMode').value = d.payMode;
    el('sumAssured').value = d.sumAssured;
    el('premium').value = d.premium;
    el('netPremium').value = d.netPremium;
    el('dealerName').value = d.dealerName;
    el('insCompany').value = d.insCompany;
    el('status').value = d.status;

    if (d.amountReceived) {
        el('premiumamt').value = d.amountReceived.amount;
        el('amountDate').value = getStandardDate(d.amountReceived.date);
        el('paymentMode').value = d.amountReceived.paymentMode;
        el('chequeDd').value = d.amountReceived.chequeDd;
        el('bankName').value = d.amountReceived.bankName;
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
    showToast("Edit mode active.", "info");
}

async function deleteLIC(id) {
    if (!confirm("Are you sure you want to delete this record?")) return;
    try {
        const res = await fetch(`${API_BASE}/api/lic/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
        const result = await res.json();
        if (!result.success) throw new Error(result.message);
        showToast("Record deleted.", "success");
        loadRecentLIC();
    } catch(err) {
        showToast(`Delete failed: ${err.message}`, 'error');
    }
}

// ===========================================
// RECENT RECORDS
// ===========================================
async function loadRecentLIC() {
    const result = await fetchJson(`${API_BASE}/api/lic/recent`);
    const tbody = el('recentLISTableBody');
    tbody.innerHTML = '';
    if (!result?.success) return;

    result.data.forEach(item => {
        const customerName = item.customer?.name || item.customerName || 'N/A';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${customerName}</td>
            <td>${item.policyNo}</td>
            <td>${item.planName}</td>
            <td>${item.premium}</td>
            <td>${getStandardDate(item.startDate)}</td>
            <td>${item.status}</td>
            <td>
                <button onclick="editLIC('${item._id}')">‚úèÔ∏è</button>
                <button onclick="deleteLIC('${item._id}')">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// ===========================================
// INITIALIZE
// ===========================================
document.addEventListener('DOMContentLoaded', () => {
    loadDropdown(`${API_BASE}/api/master/partner`, 'partner', 'name');
    loadDropdown(`${API_BASE}/api/master/item/licplan`, 'licPlan', 'name');
    loadDropdown(`${API_BASE}/api/master/item/paymentmode`, 'paymentMode', 'mode');
    loadDropdown(`${API_BASE}/api/master/bank`, 'bankName', 'name');
    initSearchLogic(); // Initialize the customer search
    initDealerLogic();
    loadRecentLIC();
});

</script>
</body>
</html>
